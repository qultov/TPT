<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#121214">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="–ü–æ–º–æ—â–Ω–∏–∫ –¢–ü">
<title>–ü–æ–º–æ—â–Ω–∏–∫ –¢–ü v21.4 (Split UI)</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
<link rel="manifest" href="manifest.json">
<!-- –î–ª—è iOS –∏–∫–æ–Ω–∫–∞ -->
<link rel="apple-touch-icon" href="icon-192.png">
<style>
/* --- DESIGN SYSTEM --- */
:root {
    --bg-body: #09090b; --bg-surface: #18181b; --bg-surface-2: #27272a; --bg-input: #121214;
    --primary: #3b82f6; --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    --primary-dim: rgba(59, 130, 246, 0.15); --primary-text: #60a5fa;
    --accent: #10b981; --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --accent-dim: rgba(16, 185, 129, 0.15);
    --danger: #ef4444; --danger-dim: rgba(239, 68, 68, 0.15);
    --warning: #f59e0b; --warning-dim: rgba(245, 158, 11, 0.15);
    --transit: #8b5cf6; --transit-dim: rgba(139, 92, 246, 0.15);
    --text-main: #f4f4f5; --text-sec: #a1a1aa; --text-muted: #52525b;
    --border-light: rgba(255, 255, 255, 0.08);
    --header-height: 60px; --nav-height: 70px; --control-height: 52px; --control-height-sm: 40px;
    --space-xs: 4px; --space-sm: 8px; --space-md: 12px; --space-lg: 16px;
    --radius-md: 14px; --radius-lg: 20px;
    --shadow-card: 0 4px 20px rgba(0,0,0,0.2); --shadow-glow: 0 0 15px rgba(59,130,246,0.25);
    --backdrop: blur(20px) saturate(180%); --glass-bg: rgba(24, 24, 27, 0.75);
    --anim-fast: 0.15s ease-out;
}
/* --- BASE & LAYOUT --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", Roboto, sans-serif; 
    background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; 
    font-size: 16px; line-height: 1.5; overflow: hidden; position: fixed; width: 100%; height: 100%; 
    -webkit-font-smoothing: antialiased;
    -webkit-user-select: none;
    user-select: none;
}
.noselect, button, .toggle-row { user-select: none; -webkit-user-select: none; }
.container { padding: 0 var(--space-lg); max-width: 600px; margin: 0 auto; width: 100%; }
.hidden { display: none!important; }

/* Fixed Layout Elements */
header, .bottom-nav { 
    position: fixed; left: 0; width: 100%; background: var(--glass-bg); 
    backdrop-filter: var(--backdrop); -webkit-backdrop-filter: var(--backdrop); 
    z-index: 2000; border-color: var(--border-light);
}
header { 
    top: 0; height: var(--header-height); border-bottom: 1px solid var(--border-light); 
    display: flex; align-items: center; padding: 0 var(--space-lg); 
}
.header-content { width: 100%; max-width: 600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
.app-logo { font-size: 18px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: var(--space-sm); letter-spacing: -0.02em; }
.version-badge { font-size: 10px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 6px; color: var(--text-sec); font-weight: 600; }

.tabs-container { position: relative; width: 100%; height: 100%; background: var(--bg-body); overflow: hidden; }
.swipe-track { 
    display: flex; width: 100%; height: 100%; overflow-x: scroll; overflow-y: hidden; 
    -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; scroll-behavior: smooth; 
    scrollbar-width: none; 
}
.swipe-track::-webkit-scrollbar { display: none!important; }
.tab-pane { 
    flex: 0 0 100%; width: 100%; height: 100%; scroll-snap-align: start; scroll-snap-stop: always; 
    overflow-y: auto; padding-top: calc(var(--header-height) + var(--space-lg)); 
    padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom) + var(--space-lg)); 
}

/* Nav */
.bottom-nav { 
    bottom: 0; height: calc(var(--nav-height) + env(safe-area-inset-bottom)); 
    border-top: 1px solid var(--border-light); display: flex; justify-content: space-around; 
    align-items: flex-start; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); 
    transition: transform 0.3s cubic-bezier(0.2,0,0,1); 
}
body.keyboard-open .bottom-nav { transform: translateY(100%); pointer-events: none; }
body.keyboard-open .edit-banner { opacity: 0; pointer-events: none; }
.nav-item { 
    background: transparent; border: none; padding: 0; display: flex; flex-direction: column; 
    align-items: center; justify-content: flex-start; gap: 4px; color: var(--text-sec); cursor: pointer; flex: 1; position: relative;
}
.nav-icon { width: 24px; height: 24px; transition: transform var(--anim-fast); }
.nav-label { font-size: 10px; font-weight: 500; letter-spacing: 0.2px; }
.nav-item.active { color: var(--primary); }
.nav-item.active .nav-icon { transform: scale(1.1); }
.nav-pill { 
    position: absolute; top: -1px; left: 0; width: 20%; height: 2px; background: var(--primary); 
    box-shadow: 0 0 10px var(--primary); border-radius: 2px; pointer-events: none; will-change: transform; 
}
.icon-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
.nav-badge { 
    position: absolute; top: -5px; right: -8px; background-color: var(--danger); color: #fff; 
    font-size: 9px; font-weight: 700; min-width: 16px; height: 16px; border-radius: 10px; 
    display: flex; align-items: center; justify-content: center; padding: 0 4px; 
    border: 2px solid var(--bg-surface); z-index: 10; animation: popIn 0.3s; 
}

/* --- FORMS --- */
label { display: flex; align-items: center; margin: 0 0 6px 4px; color: var(--text-sec); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.icon-label { font-style: normal; margin-right: 6px; font-size: 13px; opacity: 0.9; }
.input-wrapper { position: relative; width: 100%; display: flex; align-items: center; }
.input-wrapper.mb-lg { margin-bottom: var(--space-lg); }

input, select, textarea, .custom-select-btn { 
    width: 100%; height: var(--control-height); background: var(--bg-input); border: 1px solid var(--border-light); 
    border-radius: var(--radius-md); padding: 0 var(--space-lg); color: var(--text-main); font-size: 16px; 
    transition: all var(--anim-fast); display: block; font-family: inherit; appearance: none; padding-right: 40px !important;
}
input:not(.wrapped), select, textarea { margin-bottom: var(--space-lg); }
.input-wrapper input { margin-bottom: 0 !important; }
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: var(--bg-surface); box-shadow: var(--shadow-glow); }
textarea { height: auto; padding: 12px var(--space-lg); resize: none; min-height: 80px; line-height: 1.5; }
.input-sm { height: var(--control-height-sm); font-size: 14px; margin-bottom: var(--space-md); }
.custom-select-btn { text-align: left; display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 0; padding-right: var(--space-lg)!important; }
.custom-select-btn::after { content: ''; border: 5px solid transparent; border-top-color: var(--text-sec); margin-top: 4px; }
.toggles-container { display: flex; gap: var(--space-md); margin-bottom: var(--space-lg); }
.toggle-btn { 
    flex: 1; height: var(--control-height); border: 1px solid var(--border-light); background: var(--bg-surface); 
    color: var(--text-sec); font-size: 14px; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; 
    transition: all var(--anim-fast); display: flex; align-items: center; justify-content: center; gap: 6px; 
}
.toggle-btn:active { transform: scale(0.98); }
.toggle-btn.active-diff { background: var(--warning-dim); color: var(--warning); border-color: var(--warning); }
.toggle-btn.active-transit { background: var(--transit-dim); color: var(--transit); border-color: var(--transit); }
.toggle-row { 
    display: flex; align-items: center; margin-bottom: var(--space-lg); cursor: pointer; 
    background: var(--bg-surface); border: 1px solid var(--border-light); padding: 12px 16px; border-radius: var(--radius-md); 
}
.toggle-row input { display: none; }
.toggle-visual { position: relative; width: 44px; height: 24px; background: #3f3f46; border-radius: 12px; margin-right: 12px; transition: all 0.3s ease; flex-shrink: 0; }
.toggle-visual::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.toggle-row input:checked + .toggle-visual { background: var(--primary); }
.toggle-row input:checked + .toggle-visual::after { transform: translateX(20px); }
.toggle-text { font-size: 15px; font-weight: 500; color: var(--text-main); }

.btn-input-clear {
    position: absolute; right: 0; top: 0; height: 100%; width: 40px; background: transparent; border: none; 
    color: var(--text-sec); font-size: 16px; display: flex; align-items: center; justify-content: center; 
    cursor: pointer; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 5;
}
.input-wrapper input:not(:placeholder-shown) ~ .btn-input-clear,
.wrapper-with-btn input:not(:placeholder-shown) ~ .btn-input-clear { opacity: 1; visibility: visible; }
input[type="search"]::-webkit-search-decoration, input[type="search"]::-webkit-search-cancel-button { display: none; }

/* --- BUTTONS --- */
button { font-family: inherit; }
.btn-common, .btn-sec, .btn-dashed, .btn-reset, .btn-install-app, .cm-btn, .bs-action-btn { cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; }
.btn-common { 
    width: 100%; height: var(--control-height); border-radius: var(--radius-md); gap: 8px; 
    font-size: 16px; font-weight: 600; color: #fff; transition: transform 0.1s, opacity 0.2s; 
}
.btn-common:active { transform: scale(0.97); opacity: 0.9; }
.btn-main { background: var(--primary-gradient); box-shadow: 0 4px 15px rgba(59,130,246,0.3); }
.btn-finish { background: var(--accent-gradient); box-shadow: 0 4px 15px rgba(16,185,129,0.25); }
.btn-save { background: var(--bg-surface-2); color: var(--text-sec); cursor: not-allowed; }
.btn-save.dirty { background: var(--primary); color: #fff; cursor: pointer; }
.btn-sec { width: 100%; height: 44px; background: transparent; color: var(--text-sec); font-weight: 500; font-size: 14px; }
.btn-dashed { 
    border: 1px dashed var(--border-light); border-radius: var(--radius-md); color: var(--primary-text); 
    background: rgba(59,130,246,0.05); width: 100%; height: 44px; font-weight: 600; font-size: 14px; 
    margin-bottom: var(--space-lg); transition: background 0.2s; 
}
.btn-dashed:active { background: rgba(59,130,246,0.1); }
.btn-icon-small, .btn-remove { display: flex; align-items: center; justify-content: center; border: none; }
.btn-icon-small { 
    width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.05); 
    border: 1px solid var(--border-light); color: var(--text-sec); font-size: 16px; 
}
.btn-remove { 
    width: var(--control-height); height: var(--control-height); background: var(--danger-dim); color: var(--danger); 
    border-radius: var(--radius-md); font-size: 18px; flex-shrink: 0; 
}
.btn-copy { background: var(--primary-dim); color: var(--primary-text); border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; }
.btn-whatsapp { background: #25D366; color:#fff; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.25); height: 48px; gap: 10px; }
.btn-whatsapp svg { width: 20px; height: 20px; fill: currentColor; }
.btn-install-app { 
    display: none; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white; width: 100%; 
    margin-bottom: 20px; height: 60px; font-size: 16px; font-weight: 700; border-radius: var(--radius-lg); 
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); 
}
.btn-reset { width: 100%; background: transparent; border: 1px solid var(--border-light); color: var(--text-sec); height: 44px; border-radius: var(--radius-md); font-size: 13px; }

/* --- CARDS & LISTS --- */
.card, .input-card, .report-card, .settings-group { background: var(--bg-surface); border: 1px solid var(--border-light); }
.input-card, .settings-group { border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-card); margin-bottom: 24px; }
.input-card { margin-bottom: 0; }
.report-card { border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px; }
.card { 
    border-radius: var(--radius-lg); padding: 16px; position: relative; display: flex; flex-direction: column; 
    gap: 8px; transition: transform 0.1s, background 0.2s; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.3); 
}
.card:active { transform: scale(0.98); background-color: var(--bg-surface-2); }
.card.editing-focus, .ac-card.editing-focus { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
.card.is-dragging-placeholder { opacity: 0.3; background: var(--bg-surface-2); box-shadow: inset 0 0 0 2px var(--primary-dim); }
.card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.card-title { font-size: 16px; font-weight: 700; color: #fff; line-height: 1.3; }
.card-note { font-size: 13px; color: var(--text-sec); margin-top: 4px; display: flex; align-items: center; gap: 4px; line-height: 1.4; }
.cards-list { display: flex; flex-direction: column; gap: 12px; }
.empty-state { text-align: center; color: var(--text-muted); padding: 60px 0; font-size: 15px; font-weight: 500; }
.card-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.u-tag { 
    display: inline-flex; align-items: center; justify-content: center; height: 26px; padding: 0 10px; 
    border-radius: 8px; font-size: 11px; font-weight: 600; vertical-align: middle; border: 1px solid transparent; white-space: nowrap; 
}
.u-tag.tag-route { background: #333; color: #ddd; border-color: var(--border-light); }
.u-tag.tag-transit { background: var(--transit-dim); color: #c4b5fd; border-color: rgba(139, 92, 246, 0.2); }
.u-tag.tag-address { background: var(--warning-dim); color: var(--warning); border-color: rgba(245, 158, 11, 0.2); }
.u-tag.tag-amount { 
    font-family: "Menlo", monospace; background: transparent; color: var(--accent); border: none; 
    letter-spacing: -0.5px; font-size: 14px; font-weight: 700; padding: 0; height: auto; margin: 0; 
}
.u-tag.tag-amount.empty { font-size: 13px; font-weight: 500; color: var(--text-muted); padding: 2px 8px; height: 24px; border: 1px solid var(--border-light); border-radius: 6px; }

.chips-wrapper { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; max-height: 140px; overflow-y: auto; padding-bottom: 5px; align-content: flex-start;}
.chip { 
    background: var(--bg-surface-2); color: var(--text-sec); padding: 8px 14px; border-radius: 20px; 
    font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid var(--border-light); 
    transition: all 0.2s; white-space: nowrap; flex-shrink: 0; 
}
.chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }
.chip.taken { background: var(--warning-dim); color: var(--warning); border-color: rgba(245,158,11,0.3); }
.chip.chip-transit.active { background: var(--transit); color: #fff; border-color: var(--transit); }
.chip.conflict { background: #ea580c; color: #fff; border-color: #ea580c; }

/* Manager Cards */
#pointsManagerList { padding: 0 10px 80px 10px; }
.pm-card, .manager-card {
    display: flex; align-items: center; justify-content: space-between; background: var(--bg-surface);
    border: 1px solid var(--border-light); border-radius: 16px; margin-bottom: 10px; padding: 12px 16px;
    cursor: pointer; transition: transform 0.1s, background 0.2s;
}
.manager-card { border-radius: var(--radius-md); padding: 14px; margin-bottom: 8px; }
.pm-card:active, .manager-card:active { transform: scale(0.98); background: var(--bg-surface-2); border-color: var(--primary); }
.pm-info, .rm-info { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow: hidden; }
.pm-title, .rm-title { font-size: 16px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rm-title { font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.pm-badges { display: flex; flex-wrap: wrap; gap: 6px; }
.u-badge, .rm-badge { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; }
.u-badge.is-route { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }
.u-badge.is-transit { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.2); }
.u-badge.is-syn { background: rgba(255, 255, 255, 0.1); color: var(--text-sec); }
.rm-badge { background: var(--primary-dim); color: var(--primary-text); font-size: 10px; padding: 2px 6px; border-radius: 4px; }
.pm-arrow, .rm-icon { color: var(--text-sec); opacity: 0.5; margin-left: 12px; display: flex; align-items: center; justify-content: center; }
.rm-hint { font-size: 12px; color: var(--text-sec); line-height: 1.4; }

/* --- MODULES --- */
.wrapper-relative { position: relative; width: 100%; margin-bottom: var(--space-lg); }
.wrapper-with-btn input { padding-right: 50px!important; margin-bottom: 0; }
.autocomplete-list { 
    position: absolute; top: 100%; left: 0; right: 0; background: #1f1f23; border-radius: var(--radius-md); 
    z-index: 1000; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
    margin-top: 6px; border: 1px solid var(--border-light); display: none; 
}
.autocomplete-item { padding: 14px 16px; border-bottom: 1px solid var(--border-light); font-size: 15px; }
.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item:active { background: var(--primary); color: #fff; }

.ac-card { background: var(--bg-surface); border-radius: var(--radius-lg); margin-bottom: 12px; border: 1px solid var(--border-light); overflow: hidden; }
.ac-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); cursor: pointer; transition: background 0.2s; }
.ac-header:active { background: rgba(255,255,255,0.05); }
.ac-date { font-weight: 600; color: var(--text-main); font-size: 15px; display: flex; align-items: center; gap: 8px; }
.ac-body { display: none; padding: 0; border-top: 1px solid var(--border-light); }
.ac-body.open { display: block; animation: slideDown 0.2s; }
.ac-body .card { background: transparent; border: none; border-bottom: 1px solid var(--border-light); border-radius: 0; margin: 0; padding: 14px 16px; box-shadow: none; }
.ac-body .card:last-child { border-bottom: none; }
.badge-counter { background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; min-width: 24px; text-align: center; }

.menu-btn-row { 
    position: relative; display: flex; align-items: center; justify-content: space-between; 
    background: var(--bg-surface-2); padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; 
    border: 1px solid var(--border-light); cursor: pointer; transition: all 0.2s; 
}
.menu-btn-row:active { background: #333; transform: scale(0.99); }
.mbr-icon { font-size: 20px; margin-right: 12px; display: inline-block; width: 30px; text-align: center; }
.mbr-title { flex: 1; font-weight: 600; font-size: 15px; color: #fff; }
.mbr-badge { background: #3f3f46; color: var(--text-sec); font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 600; margin-right: 8px; }
.settings-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
.settings-grid-container .menu-btn-row { flex-direction: column; align-items: center; justify-content: center; text-align: center; margin-bottom: 0; height: 110px; padding: 15px; }
.settings-grid-container .mbr-icon { font-size: 32px; margin-bottom: 10px; margin-right: 0; width: auto; }
.settings-grid-container .mbr-title { font-size: 13px; line-height: 1.3; width: 100%; }
.settings-grid-container .mbr-badge { position: absolute; top: 10px; right: 10px; margin: 0; font-size: 11px; }
.settings-grid-container .menu-btn-row.span-2 { grid-column: 1 / -1; }

.bs-overlay, .full-screen-manager, .custom-modal { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
}
.full-screen-manager { 
    background: var(--bg-body); z-index: 2500; display: flex; flex-direction: column; 
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); visibility: hidden; 
}
.full-screen-manager.active { transform: translateX(0); visibility: visible; }
.fsm-header { 
    height: var(--header-height); flex-shrink: 0; display: flex; justify-content: space-between; 
    align-items: center; padding: 0 var(--space-lg); background: var(--glass-bg); 
    backdrop-filter: var(--backdrop); border-bottom: 1px solid var(--border-light); 
}
.fsm-back-btn { background: none; border: none; color: var(--primary-text); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 0; }
.fsm-title { font-size: 17px; font-weight: 700; color: #fff; }
.fsm-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: calc(env(safe-area-inset-bottom) + 20px); display: flex; flex-direction: column; }
.sticky-search { position: sticky; top: 0; z-index: 10; background: var(--bg-body); padding: 10px 0; margin-bottom: 10px; }

/* --- FIXES (–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø) --- */

/* 1. –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—Å–µ –æ–±–µ—Ä—Ç–∫–∏ —Å –∞–≤—Ç–æ-–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤—ã—à–µ —Å–æ—Å–µ–¥–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.autocomplete-wrapper {
    z-index: 50; 
}

/* 2. –ü–æ–¥–Ω–∏–º–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ –∞–¥—Ä–µ—Å–∞ –≤—ã—à–µ, —á–µ–º –ø–æ–ª–µ –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∏–¥–µ—Ç —Å–ª–µ–¥–æ–º */
.hidden-fields {
    position: relative;
    z-index: 40; 
}

/* 3. –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –ø–æ–ª–µ "–¢–æ—á–∫–∞" (—Å–∞–º–æ–µ –≤–µ—Ä—Ö–Ω–µ–µ) —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ –≤—Å—ë –ø–æ–¥ –Ω–∏–º */
.input-card .autocomplete-wrapper:first-child {
    z-index: 60;
}

/* --- HINTS & HELPERS --- */
.context-hint { 
    background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); 
    border-radius: var(--radius-md); padding: 12px; margin-bottom: 16px; 
    display: none; animation: slideDown 0.3s; align-items: flex-start; gap: 12px; position: relative;
}
.context-hint.active { display: flex; }
.context-hint.warning { border-color: rgba(245, 158, 11, 0.4); background: rgba(245, 158, 11, 0.15); }
.hint-icon { font-size: 20px; line-height: 1; margin-top: 2px; }
.hint-title { font-size: 10px; font-weight: 700; color: var(--primary-text); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.8px; opacity: 0.8; }
.context-hint.warning .hint-title { color: var(--warning); opacity: 1; }
.hint-text { font-size: 13px; color: #e4e4e7; line-height: 1.5; }
.context-hint.warning .hint-text { color: #fde68a; }
.rule-tag { display: inline-block; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600; margin: 0 2px; }
.btn-reset-context {
    background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: #fff; 
    border-radius: 6px; padding: 6px 10px; font-size: 11px; font-weight: 600; cursor: pointer; 
    margin-top: 8px; display: none; align-items: center; gap: 4px;
}
.context-hint.warning .btn-reset-context { display: inline-flex; background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.3); color: #fff; }

.label-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.amounts-container { margin-bottom: 12px; }
.amount-row { display: flex; gap: 10px; margin-bottom: 10px; }
.amount-row input { margin-bottom: 0; font-family: monospace; font-size: 18px; letter-spacing: -0.5px; }
.section-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
.section-title { font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
.divider { height: 1px; background: var(--border-light); margin: 20px 0; }
.text-danger { color: var(--danger)!important; }
.hidden-fields { display: none; background: rgba(0,0,0,0.2); padding: 16px; border-radius: var(--radius-md); margin-bottom: 16px; border-left: 3px solid var(--warning); }
.hidden-fields.active { display: block; animation: slideDown 0.2s forwards; }
.settings-header { font-size: 11px; font-weight: 800; color: var(--primary-text); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 16px; opacity: 0.9; }
.report-toolbar { background: var(--bg-surface-2); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); }
.report-label { font-size: 11px; font-weight: 800; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
.report-content { padding: 16px; font-family: "Menlo", monospace; font-size: 12px; color: #ddd; white-space: pre-wrap; line-height: 1.5; -webkit-user-select: text; user-select: text;}

/* --- MODALS & OVERLAYS --- */
.bs-overlay { 
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 3000; opacity: 0; visibility: hidden; 
    transition: 0.3s; display: flex; align-items: flex-end; 
}
.bs-overlay.active { opacity: 1; visibility: visible; }
.bs-panel { 
    width: 100%; background: #1c1c1e; border-radius: 24px 24px 0 0; 
    padding: 24px; padding-bottom: calc(24px + env(safe-area-inset-bottom)); 
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2,0.9,0.3,1); 
    max-height: 85vh; display: flex; flex-direction: column; border-top: 1px solid var(--border-light); 
    box-shadow: 0 -10px 40px rgba(0,0,0,0.6); position: relative; overflow: hidden;
    will-change: transform; backface-visibility: hidden; -webkit-backface-visibility: hidden;
}
.bs-panel::before { 
    content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); 
    width: 36px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 3px; pointer-events: none; 
}
.bs-overlay.active .bs-panel { transform: translateY(0); }
.bs-header { text-align: center; font-weight: 700; color: #fff; margin-bottom: 24px; font-size: 17px; margin-top: 8px; }
.bs-content { overflow-y: auto; touch-action: pan-y; -webkit-overflow-scrolling: touch; }
.bs-item { 
    width: 100%; padding: 16px; background: var(--bg-surface-2); border: 1px solid var(--border-light); 
    border-radius: 16px; color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 10px; 
    cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
}
.bs-item:active { transform: scale(0.98); background: #333; }
.bs-item.selected { border-color: var(--primary); background: rgba(59,130,246,0.1); color: var(--primary-text); }
.bs-action-btn { 
    width: 100%; padding: 18px; background: rgba(255,255,255,0.03); margin: 0; 
    border-bottom: 1px solid var(--border-light); color: #fff; font-size: 16px; font-weight: 500; 
    gap: 16px; text-align: left; border-radius: 0; 
}
.bs-action-btn:first-child { border-radius: 16px 16px 0 0; }
.bs-action-btn:last-child { border-radius: 0 0 16px 16px; border-bottom: none; }
.bs-action-btn:active { background: rgba(255,255,255,0.08); }
.bs-action-btn.danger { color: var(--danger); }

.custom-modal { 
    display: none; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 4000; 
    align-items: center; justify-content: center; 
}
.custom-modal.active { display: flex; animation: fadeIn 0.2s; }
.cm-card { 
    background: #222226; width: 85%; max-width: 320px; border-radius: 24px; padding: 24px; 
    text-align: center; border: 1px solid var(--border-light); box-shadow: 0 20px 60px rgba(0,0,0,0.7); 
    transform: scale(0.9); animation: popIn 0.2s forwards; 
}
.cm-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #fff; }
.cm-text { font-size: 15px; color: var(--text-sec); margin-bottom: 24px; line-height: 1.5; }
.cm-btns { display: flex; gap: 12px; }
.cm-btn { flex: 1; height: 48px; border-radius: 14px; font-weight: 600; font-size: 15px; }
.cm-confirm { background: var(--primary); color: #fff; }
.cm-danger { background: var(--danger); color: #fff; }
.cm-cancel { background: #333; color: #ccc; }

.edit-banner { 
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%); 
    background: var(--warning-dim); border: 1px solid var(--warning); color: var(--warning); 
    padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; z-index: 80; 
    display: flex; align-items: center; gap: 8px; backdrop-filter: blur(8px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
}
.toast-notification { 
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); 
    background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(10px); 
    border: 1px solid var(--border-light); color: #fff; padding: 12px 24px; border-radius: 30px; 
    font-size: 14px; font-weight: 600; z-index: 5000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
    animation: slideUpFade 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    display: flex; align-items: center; gap: 10px; pointer-events: none; 
    width: max-content; max-width: 92vw; white-space: nowrap; justify-content: center;
}
@media (max-width: 400px) { .toast-notification { white-space: normal; text-align: center; border-radius: 20px; } }

.card-clone { 
    position: fixed; z-index: 10000; pointer-events: none; box-shadow: 0 15px 40px rgba(0,0,0,0.6); 
    transform: scale(1.05) rotate(1deg); opacity: 0.95; border-radius: var(--radius-lg); 
    background: var(--bg-surface); border: 1px solid var(--primary); width: 100%; transform-origin: center center; 
}
body.dragging-active { overflow: hidden !important; user-select: none; touch-action: none; }
.pulse-icon { animation: pulse 1.5s infinite; }
.ghost-hint { font-size: 11px; opacity: 0.6; margin-left: 6px; color: var(--warning); display: inline-flex; align-items: center; gap: 4px; }
.flash-field { animation: flashInput 0.8s ease-out; }
.cheat-content-scroll { max-height: 50vh; overflow-y: auto; margin-bottom: 15px; }
.cheat-row { display: flex; border-bottom: 1px solid var(--border-light); padding: 10px 0; }
.cheat-route { width: 60px; font-weight: 700; color: var(--warning); margin-right: 12px; flex-shrink: 0; }
.cheat-desc { font-size: 13px; color: #ccc; line-height: 1.4; }

/* Utilities */
.flex-row { display: flex; align-items: center; }
.gap-10 { gap: 10px; } .flex-2 { flex: 2; }
.mt-10 { margin-top: 10px; } .mt-20 { margin-top: 20px; } .mt-30 { margin-top: 30px; } .mt-40 { margin-top: 40px; }
.mb-10 { margin-bottom: 10px; } .mb-15 { margin-bottom: 15px; }
.p-0 { padding: 0!important; } .m-0 { margin: 0!important; } .p-20 { padding: 20px; }
.max-w-90 { max-width: 90%; } .text-left { text-align: left; } .bg-transparent { background: transparent!important; }
.route-row { margin-bottom: var(--space-lg); transition: margin-bottom 0.2s; }
.route-hint-text { font-size: 13px; color: var(--warning); padding-left: 5px; line-height: 1.4; display: none; min-height: 0; margin-top: -8px; margin-bottom: 16px; }

/* Layering */
#routeEditorSheet, #pointEditorSheet, #noteEditorSheet, #contactEditorSheet { z-index: 3100 !important; }
#bottomSheet { z-index: 3500 !important; }

/* Sheet Scroll Layout */
.bs-flex-wrapper { display: flex; flex-direction: column; height: 70vh; max-height: 80vh; overflow: hidden; }
.bs-static-top { flex-shrink: 0; padding-bottom: 16px; background: #1c1c1e; margin-bottom: 0; z-index: 2; position: relative; border-bottom: 1px solid var(--border-light); }
.bs-scroll-part { flex: 1; overflow-y: auto; min-height: 0; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; padding-bottom: 0 !important; margin-bottom: 0 !important; }
.bs-static-bottom { flex-shrink: 0; padding-top: 16px; background: #1c1c1e; z-index: 2; border-top: 1px solid var(--border-light); }
.bs-content.no-scroll { overflow: hidden !important; display: flex; flex-direction: column; height: 100%; }

.parent-info-block {
    background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: var(--radius-md); padding: 12px; margin-bottom: 20px;
    display: flex; flex-direction: column; gap: 8px;
}
.parent-info-title { font-size: 11px; font-weight: 700; color: var(--primary-text); text-transform: uppercase; letter-spacing: 0.5px; }
.parent-info-text { font-size: 14px; color: #fff; font-weight: 500; display: flex; align-items: center; gap: 6px; }

/* Replacements Visualization */
.repl-container { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 4px; }
.repl-header { font-size: 10px; font-weight: 700; color: #93c5fd; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; }
.repl-flow { font-size: 13px; line-height: 1.4; color: #e4e4e7; }
.val-fact { color: #9ca3af; word-break: break-word; }
.val-arrow { color: rgba(255,255,255,0.3); margin: 0 5px; font-weight: 300; }
.val-invoice { color: #fff; font-weight: 600; word-break: break-word; }

/* --- ROUTE SHEET STYLES --- */
.bs-item.route-split-item {
    padding: 0;
    justify-content: flex-start;
    align-items: stretch;
    min-height: 60px;
    overflow: hidden;
}
.rsi-left {
    width: 85px; /* –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–∞—Ä—à—Ä—É—Ç–∞ */
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 18px;
    background: rgba(255,255,255,0.03);
    color: #fff;
}
.rsi-divider {
    width: 1px;
    background: var(--border-light);
}
.rsi-right {
    flex: 1;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    font-size: 12px;
    line-height: 1.35;
    color: var(--text-sec);
}
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ */
.bs-item.route-split-item.selected .rsi-left {
    background: var(--primary);
    color: #fff;
}
.bs-item.route-split-item.selected .rsi-right {
    color: #ddd;
    background: rgba(59, 130, 246, 0.1);
}

/* Animations */
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: .5; } 100% { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes flashInput { 0% { border-color: var(--warning); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); background: rgba(245, 158, 11, 0.1); } 100% { border-color: var(--border-light); background: var(--bg-input); } }
@keyframes slideUpFade { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
</style>
</head>
<body>

<header id="appHeader">
<div class="header-content">
<div class="app-logo"><img width="40" height="40" src="./icon.svg" alt="box"/>–ü–æ–º–æ—â–Ω–∏–∫ –¢–ü <span class="version-badge">v21.4</span></div>
<div id="headerActionArea"></div>
</div>
</header>

<div id="editModeBanner" class="edit-banner" style="display:none"><span class="pulse-icon">‚úèÔ∏è</span> –†–ï–ñ–ò–ú –ü–†–ê–í–ö–ò</div>

<main class="tabs-container">
<div id="swipeTrack" class="swipe-track">
<section id="tab-input" class="tab-pane active">
<div class="container">
<div class="input-card">
<label><i class="icon-label">üè™</i> –¢–æ—á–∫–∞ / –ö–ª–∏–µ–Ω—Ç</label>
<div class="wrapper-with-btn autocomplete-wrapper wrapper-relative">
<input type="text" id="pointInput" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off">
<button class="btn-input-clear" onclick="clearInput('pointInput')" tabindex="-1">‚úï</button>
<div id="pointAutocompleteList" class="autocomplete-list"></div>
</div>

<div id="mappingHintBlock" class="context-hint">
    <div class="hint-icon">üëª</div>
    <div class="hint-content" style="flex:1">
        <div class="hint-title" id="hintTitle">–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞</div>
        <div class="hint-text" id="mappingHintText"></div>
        <button id="btnResetContext" class="btn-reset-context" onclick="resetToOriginalContext()">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å –∫ –ø—Ä–∞–≤–∏–ª–∞–º</button>
    </div>
</div>

<label><i class="icon-label">üí∞</i> –°—É–º–º—ã</label>
<div id="amountsContainer" class="amounts-container"></div>
<button class="btn-dashed" onclick="addAmountField()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—É–º–º—É</button>
<label><i class="icon-label">‚ö°</i> –û–ø—Ü–∏–∏ –∑–∞—è–≤–∫–∏</label>
<div class="toggles-container">
    <button id="btnToggleDiff" class="toggle-btn" onclick="toggleAddressMode();checkContextDifferences()">üìç –£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å</button>
    <button id="btnToggleTransit" class="toggle-btn" onclick="toggleTransitMode();checkContextDifferences()">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</button>
</div>
<div id="diffAddressBlock" class="hidden-fields">
<label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
<div class="autocomplete-wrapper wrapper-with-btn wrapper-relative">
<input type="text" id="factAddressInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." autocomplete="off">
<button class="btn-input-clear" onclick="clearInput('factAddressInput')" tabindex="-1">‚úï</button>
<div id="factAddressList" class="autocomplete-list"></div>
</div>
</div>
<label class="label-header">
<span><i class="icon-label">üó∫</i> –ú–∞—Ä—à—Ä—É—Ç</span>
</label>
<div class="route-row">
<div class="route-wrapper">
<select id="routeSelect" style="display:none"></select>
<button id="routeSelectBtn" class="custom-select-btn" onclick="openRouteSheet()">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</button>
</div>
</div>
<div class="label-header">
<label class="m-0"><i class="icon-label">üìù</i> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
<button class="btn-dashed" style="width:auto;height:32px;font-size:11px;padding:0 12px;margin:0 0 5px 0" onclick="openNoteSheet()">–í—ã–±—Ä–∞—Ç—å...</button>
</div>
<div class="wrapper-with-btn wrapper-relative">
<input type="text" id="noteInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ..." autocomplete="off">
<button class="btn-input-clear" onclick="clearInput('noteInput')" tabindex="-1">‚úï</button>
</div>
<div class="form-actions-row mt-20">
<button id="mainActionBtn" class="btn-common btn-main flex-2" onclick="handleMainAction()">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>
</div>
<button id="cancelEditBtn" class="btn-sec text-danger mt-10" style="display:none" onclick="resetForm()">–û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</button>
</div>
</div>
</section>

<section id="tab-list" class="tab-pane">
<div class="container">
<div class="section-header-row">
<div class="section-title">–¢–µ–∫—É—â–∏–µ –∑–∞—è–≤–∫–∏</div>
<div class="badge-counter" id="draftCount">0</div>
</div>
<div id="draftList" class="cards-list">
<div class="empty-state">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
</div>
<div class="mt-30">
<button id="archiveBtn" class="btn-common btn-finish" style="display:none" onclick="saveToArchive()"><span>üèÅ</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å</button>
</div>
<button id="cancelArchiveEditBtn" class="btn-sec mt-10" style="display:none" onclick="cancelArchiveEdit()">–í—ã–π—Ç–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞</button>
</div>
</section>

<section id="tab-reports" class="tab-pane">
<div class="container">
<div class="report-card">
<div class="report-toolbar">
<div class="report-label">üë§ –î–ª—è –û–ø–µ—Ä–∞—Ç–æ—Ä–∞</div>
<button class="btn-copy" onclick="copyReportText($('reportOperator').textContent)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
<div class="report-content" id="reportOperator"></div>
<div style="padding:0 16px 16px 16px">
<button class="btn-common btn-whatsapp" onclick="handleSendReport('operator')"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É</button>
</div>
</div>

<div class="report-card">
<div class="report-toolbar">
<div class="report-label">üöö –î–ª—è –≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä–∞</div>
<button class="btn-copy" onclick="copyReportText($('reportExpeditor').textContent)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
<div class="report-content" id="reportExpeditor"></div>
<div style="padding:0 16px 16px 16px">
<button class="btn-common btn-whatsapp" onclick="handleSendReport('expeditor')"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç —ç–∫—Å–ø–µ–¥–∏—Ç–æ—Ä—É</button>
</div>
</div>
</div>
</section>

<section id="tab-archive" class="tab-pane">
<div class="container">
<div class="section-header-row">
<div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –¥–Ω–µ–π</div>
<button class="btn-icon-small" onclick="clearAllArchive()">üóë</button>
</div>
<div id="archiveContainer"></div>
</div>
</section>

<section id="tab-settings" class="tab-pane">
<div class="container">
<button id="installAppBtn" class="btn-install-app" onclick="installPWA()">üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω</button>

<div class="settings-grid-container">
    <div class="menu-btn-row" onclick="openPointsManagerScreen()">
        <span class="mbr-icon">üóÇ</span><span class="mbr-title">–ë–∞–∑–∞ —Ç–æ—á–µ–∫</span><span class="mbr-badge" id="pointsCountBadge">0</span>
    </div>
    <div class="menu-btn-row" onclick="openRoutesManagerScreen()">
        <span class="mbr-icon">üó∫</span><span class="mbr-title">–ú–∞—Ä—à—Ä—É—Ç—ã</span><span class="mbr-badge" id="routesCountBadge">0</span>
    </div>
    <div class="menu-btn-row" onclick="openNotesManagerScreen()">
        <span class="mbr-icon">üìù</span><span class="mbr-title">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</span><span class="mbr-badge" id="notesCountBadge">0</span>
    </div>
    <div class="menu-btn-row" onclick="openContactsManagerScreen()">
        <span class="mbr-icon">‚òéÔ∏è</span><span class="mbr-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span><span class="mbr-badge" id="contactsCountBadge">0</span>
    </div>
    <div class="menu-btn-row span-2" onclick="openDataManagerScreen()">
        <span class="mbr-icon">Ô∏èüíæ</span><span class="mbr-title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
    </div>
</div>

<textarea id="settingRoutes" class="hidden"></textarea>
<textarea id="settingNotes" class="hidden"></textarea>
<input type="file" id="importFile" style="display:none" accept=".json" onchange="importDb(this)">

<div class="mt-40 buttons-row">
<button id="saveSettingsBtn" class="btn-save btn-common" style="width:100%" onclick="saveSettings()" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button id="cancelSettingsBtn" class="btn-reset mt-10" style="width:100%;height:50px;display:none" onclick="revertSettings()">–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</div>
</div>
</section>
</div>
</main>

<nav class="bottom-nav">
<button class="nav-item active" onclick="switchTab('tab-input',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
<span class="nav-label">–ù–æ–≤–∞—è</span>
</button>
<button class="nav-item" onclick="switchTab('tab-list',this)">
<div class="icon-wrapper">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
<span id="navBadge" class="nav-badge" style="display:none">0</span>
</div>
<span class="nav-label">–°–ø–∏—Å–æ–∫</span>
</button>
<button class="nav-item" onclick="switchTab('tab-reports',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
<span class="nav-label">–û—Ç—á–µ—Ç—ã</span>
</button>
<button class="nav-item" onclick="switchTab('tab-archive',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
<span class="nav-label">–ò—Å—Ç–æ—Ä–∏—è</span>
</button>
<button class="nav-item" onclick="switchTab('tab-settings',this)">
<svg class="nav-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.15 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
<span class="nav-label">–ú–µ–Ω—é</span>
</button>
<div class="nav-pill"></div>
</nav>

<div id="bottomSheet" class="bs-overlay" onclick="closeBottomSheet(event)">
<div id="bsPanel" class="bs-panel"><div id="bsHeader" class="bs-header">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</div><div id="bsContent" class="bs-content"></div></div>
</div>

<div id="customModal" class="custom-modal">
<div class="cm-card"><div id="cmTitle" class="cm-title"></div><div id="cmText" class="cm-text"></div><input type="text" id="cmInput" class="cm-input" style="display:none" autocomplete="off"><div class="cm-btns" id="cmButtons"></div></div>
</div>

<div id="view-routes-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="vibrate();closeEditorSheet(null,'view-routes-manager');updateBadgesFromInputs()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ú–∞—Ä—à—Ä—É—Ç—ã</div><div class="header-action"><button class="btn-icon-small" style="width:36px; height:36px; border-radius:10px; border:none; background:var(--primary); color:#fff;" onclick="openRouteEditor()">+</button></div></div>
    <div class="fsm-content"><div id="routesManagerList"></div></div>
</div>

<div id="view-contacts-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="vibrate();closeEditorSheet(null,'view-contacts-manager');updateBadgesFromInputs()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div style="width:60px"></div></div>
    <div class="fsm-content">
        <div class="section-header-row mt-10" style="padding:0 4px;"><div class="settings-header m-0">üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã</div><button class="btn-icon-small" style="width:32px; height:32px; border-radius:8px; background:rgba(59,130,246,0.15); color:var(--primary); border:none;" onclick="openContactEditor(null, 'operator')">+</button></div>
        <div id="contactsOperatorList" class="cards-list mb-15"></div>
        <div class="divider"></div>
        <div class="section-header-row" style="padding:0 4px;"><div class="settings-header m-0">üöö –≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä—ã</div><button class="btn-icon-small" style="width:32px; height:32px; border-radius:8px; background:rgba(16,185,129,0.15); color:var(--accent); border:none;" onclick="openContactEditor(null, 'expeditor')">+</button></div>
        <div id="contactsExpeditorList" class="cards-list"></div>
    </div>
</div>

<div id="view-notes-manager" class="full-screen-manager">
    <div class="fsm-header"><button class="fsm-back-btn" onclick="vibrate();closeEditorSheet(null,'view-notes-manager');updateBadgesFromInputs()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥</button><div class="fsm-title">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div><div class="header-action"><button class="btn-icon-small" style="width:36px; height:36px; border-radius:10px; border:none; background:var(--primary); color:#fff;" onclick="openNoteEditor()">+</button></div></div>
    <div class="fsm-content"><div id="notesManagerList" class="mt-10"></div></div>
</div>

<div id="view-points-manager" class="full-screen-manager">
    <div class="fsm-header">
        <button class="fsm-back-btn" onclick="vibrate();closeEditorSheet(null,'view-points-manager');updateBadgesFromInputs()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥
        </button>
        <div class="fsm-title">–ë–∞–∑–∞ —Ç–æ—á–µ–∫</div>
        <div class="header-action"><button id="btnPointAdd" class="btn-icon-small" style="width:36px; height:36px; border-radius:10px; border:none; background:var(--primary); color:#fff;" onclick="openPointEditor()">+</button></div>
    </div>
    <div class="fsm-content" style="display: flex; flex-direction: column; overflow: hidden;">
        <div id="pointsListContainer" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
            <div class="sticky-search" style="position: relative; top: 0; flex-shrink: 0; padding-top: 10px; padding-bottom: 10px;">
                <div class="input-wrapper"><input type="search" id="pointsManagerSearch" placeholder="–ü–æ–∏—Å–∫..." class="input-sm" style="margin:0;"><button class="btn-input-clear" onclick="clearInput('pointsManagerSearch')" tabindex="-1">‚úï</button></div>
            </div>
            <div id="pointsManagerList" class="" style="flex: 1; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="view-data-manager" class="full-screen-manager">
    <div class="fsm-header">
        <button class="fsm-back-btn" onclick="vibrate();closeEditorSheet(null,'view-data-manager')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> –ù–∞–∑–∞–¥
        </button>
        <div class="fsm-title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
        <div style="width:60px"></div>
    </div>
    <div class="fsm-content" style="padding: 20px;">
        <div class="settings-group">
            <div class="settings-header">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div style="font-size:13px; color:#aaa; margin-bottom:15px;">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª —Å –±–∞–∑–æ–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞ –∏–ª–∏ —Å–º–µ–Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
            </div>
            <button class="btn-common btn-main mb-15" onclick="exportData()">üíæ –°–∫–∞—á–∞—Ç—å –±–∞–∑—É (Backup)</button>
            <button class="btn-dashed" onclick="$('importFile').click()">üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
        </div>

        <div class="settings-group" style="border-color: rgba(239, 68, 68, 0.3);">
            <div class="settings-header text-danger">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div>
            <button class="btn-reset text-danger" onclick="fullReset()">üóë –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
        </div>
    </div>
</div>

<div id="routeEditorSheet" class="bs-overlay" onclick="closeEditorSheet(event, 'routeEditorSheet')">
    <div class="bs-panel"><div class="bs-header" id="routeEditorTitle">–ú–∞—Ä—à—Ä—É—Ç</div><div class="bs-content">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</label><div class="input-wrapper mb-lg"><input type="text" id="editRouteName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4/4"><button class="btn-input-clear" onclick="clearInput('editRouteName')" tabindex="-1">‚úï</button></div>
        <label>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (–†–∞–π–æ–Ω—ã)</label><textarea id="editRouteHint" rows="3" placeholder="–†–∞–π–æ–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é..."></textarea>
        <div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveRouteFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteRoute" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteRouteFromEditor()">üóë</button></div></div></div>
</div>

<div id="pointEditorSheet" class="bs-overlay" onclick="closeEditorSheet(event, 'pointEditorSheet')">
    <div class="bs-panel"><div class="bs-header" id="pointEditorTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
    <div class="bs-content"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏</label><div class="input-wrapper mb-lg"><input type="text" id="editPointName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–≥–∞–∑–∏–Ω –ê—Ä–∞–π"><button class="btn-input-clear" onclick="clearInput('editPointName')" tabindex="-1">‚úï</button></div>
    <div class="settings-group" style="margin-top:15px; padding:15px; border-radius:16px;">
        <div class="settings-header" style="margin-bottom:10px">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</div><label style="margin-bottom:5px">–ú–∞—Ä—à—Ä—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
        <div class="wrapper-relative" style="margin-bottom:15px"><button id="editPointRouteBtn" class="custom-select-btn" onclick="openPointRouteSheet()">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</button></div>
        <label class="toggle-row bg-transparent p-0 m-0" style="border:none; margin-bottom:15px!important;"><input type="checkbox" id="editPointTransitToggle"><div class="toggle-visual"></div><div class="toggle-text">–†–µ–∂–∏–º ¬´–¢—Ä–∞–Ω–∑–∏—Ç¬ª</div></label>
        <div class="divider" style="margin: 15px 0; opacity:0.3"></div>
        <div class="settings-header" style="margin-bottom:5px">–ü—Ä–∏–≤—è–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤</div><button class="btn-dashed" onclick="openSynonymSelector()">üîó –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–¥—Ä–µ—Å–∞ (<span id="synCount">0</span>)</button><div id="synPreview" class="card-tags" style="margin-top:8px;"></div>
    </div>
    <div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="savePointUnified()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeletePoint" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deletePointFromEditor()">üóë</button></div></div></div>
</div>

<div id="noteEditorSheet" class="bs-overlay" onclick="closeEditorSheet(event, 'noteEditorSheet')">
    <div class="bs-panel"><div class="bs-header" id="noteEditorTitle">–ö–Ω–æ–ø–∫–∞</div><div class="bs-content"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏</label><div class="input-wrapper mb-lg"><input type="text" id="editNoteName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í –û—Ñ–∏—Å"><button class="btn-input-clear" onclick="clearInput('editNoteName')" tabindex="-1">‚úï</button></div><div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveNoteFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteNote" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteNoteFromEditor()">üóë</button></div></div></div>
</div>

<div id="contactEditorSheet" class="bs-overlay" onclick="closeEditorSheet(event, 'contactEditorSheet')">
    <div class="bs-panel"><div class="bs-header" id="contactEditorTitle">–ö–æ–Ω—Ç–∞–∫—Ç</div><div class="bs-content">
        <label>–ò–º—è / –ú–µ—Ç–∫–∞</label><div class="input-wrapper mb-lg"><input type="text" id="contactNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ñ–∏—Å" autocomplete="off"><button class="btn-input-clear" onclick="clearInput('contactNameInput')" tabindex="-1">‚úï</button></div>
        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label><div class="input-wrapper mb-lg"><input type="tel" id="contactPhoneInput" placeholder="7701..." autocomplete="off"><button class="btn-input-clear" onclick="clearInput('contactPhoneInput')" tabindex="-1">‚úï</button></div>
        <div class="buttons-row mt-20" style="display:flex; gap:10px;"><button class="btn-common btn-main" onclick="saveContactFromEditor()">–ì–æ—Ç–æ–≤–æ</button><button id="btnDeleteContact" class="btn-remove" style="width:54px; height:54px; border-radius:12px; display:none;" onclick="deleteContactFromEditor()">üóë</button></div></div></div>
</div>

<input type="datetime-local" id="archiveDatePicker" style="position:absolute;top:-9999px;visibility:hidden;">
<script>
const $=id=>document.getElementById(id), $$=sel=>document.querySelectorAll(sel);
const vibrate=(p=10)=>{if(navigator.vibrate)navigator.vibrate(p)};
const toggleCls=(el,cls,c)=>el.classList[c?'add':'remove'](cls);
const RU_MAP={'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'e','–∂':'zh','–∑':'z','–∏':'i','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'h','—Ü':'c','—á':'ch','—à':'sh','—â':'sch','—ä':'','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya'};
const getSearchCode=str=>{if(!str)return"";return str.toLowerCase().split('').map(c=>RU_MAP[c]||c).join('').replace(/x/g,'h').replace(/h/g,'g').replace(/[cq]/g,'k').replace(/ck/g,'k').replace(/[yj]/g,'i').replace(/z/g,'s').replace(/ph/g,'f').replace(/[^a-z0-9]/g,'')};
const DB={get:(key,def=[])=>{try{return JSON.parse(localStorage.getItem(key))||def}catch{return def}},set:(key,val)=>localStorage.setItem(key,JSON.stringify(val))};
const parseList=val=>val.split(',').map(s=>s.trim()).filter(Boolean);
const DEFAULTS={routes:["1/1","2/1","4/3","4/4","–°–ó"],notes:["–¢–∞—Å–±—É–≥–µ—Ç","–ö–æ–ª—å—Ü–µ–≤–∞—è","–ö–∞–∑–ì—é–∞","–¶–µ–Ω—Ç—Ä","–í–æ–Ω—é—á–∫–∞","–ö–ë–ò"]};
const DEFAULT_HINTS={"1/1":"–¶–ï–ù–¢–†, –ñ–ê–ô–ù–ê, –ú–ï–†–ï–ô, –ê–ö–ú–ï–ß–ï–¢–¨, –ó–£–ë–ï–ù–ö–ê, –ü–ï–†–û–ù","2/1":"–ê–†–ê–ô, –®“∞–ì–´–õ–ê, 1000 –ú–ï–õ–û–ß–ï–ô, –£–ù–ò–í–ï–†–°–ê–ú, –î–≠–£, –ù–ê–ë–ï–†–ï–ñ–ù–ê–Ø, –û–ú–¶, –ù–ê–õ–û–ì–û–í–ê–Ø, –õ–ï–í–´–ô –ë–ï–†–ï–ì, –ê–í–¢–û–í–û–ö–ó–ê–õ, –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê, –ï–í–†–ê–ó–ò–Ø","4/3":"–¢–û–†–ê–ô–ì–´–†–û–í–ê, –¢–ò–¢–û–í, –ì–ê–ì–ê–†–ò–ù, –®–ê–ù–•–ê–ô, –ö–û–ú–ú–£–ù–ò–ó–ú, –ö–ë–ò, –ë–ï–õ–ö”®–õ, –ö–û–ú–°–û–ú–û–õ, –ê–õ–¨-–§–ê–†–ê–ë–ò","4/4":"–ù–û–í–û–°–¢–†–û–ô–ö–ê, –í–ó–õ–ï–¢–ö–ê, “ö–û–†“ö–´–¢-–ê–¢–ê, –¢”®–õ–ï –ë–ò, –ö–ò–†–û–í, –ù–ê–£–†–´–ó, –ù–û–í–´–ô –ë–ê–ó–ê–†, –ù–û–í.–ú–ï–ß–ï–¢–¨, –ê–ì–†–û–ü–†–û–ú, –¢–ê–°–ë”®–ì–ï–¢, –ó–ê–í–û–î–°–ö–ê–Ø, –°–ê–Ø–•–ê–¢, –°–ê–ë–ê–õ–ê“ö, –°–´“í–ê–ù–ê“ö, –ê–ù–ê –ú–ï–ù –ë–ê–õ–ê, –ò–ü–ü–û–î–†–û–ú","–°–ó":"–°–ê–ú–û–í–´–í–û–ó"};
let state={draft:[],archive:[],pointsDB:[],refRoutes:[],refNotes:[],routeHints:{},contacts:{operator:[],expeditor:[]},editingId:null,archiveEditId:null,stash:[],originalContext:{hasRule:!1,route:null,isTransit:null,isDiff:null,factAddr:null}};
let pressTimer=null,isLongPress=!1,tempHints={},tempContacts={operator:[],expeditor:[]},tempPointsDB=[],tempSynonyms=[],currentBindRoute='';

function init(){try{loadData();if(!Array.isArray(state.refRoutes))state.refRoutes=DEFAULTS.routes;renderRefLists();setupAutocomplete('pointInput','pointAutocompleteList',null);setupAutocomplete('factAddressInput','factAddressList',null);
$('pointInput').addEventListener('blur',e=>performPhantomSwap(e.target.value.trim()));
$('routeSelect').addEventListener('change',()=>{checkContextDifferences()});
$('pointInput').addEventListener('input',e=>checkRouteBinding(e.target.value));
$('factAddressInput').addEventListener('input',()=>checkContextDifferences());
$('noteInput').addEventListener('input',e=>highlightActiveNotes(e.target.value));
['settingRoutes','settingNotes'].forEach(id=>{const el=$(id);if(el)el.addEventListener('input',checkSettingsDirty)});
$('pointsManagerSearch').addEventListener('input',renderPointsManager);setupKeyboardBehavior();setupBottomSheetSwipe();resetForm();renderDraft();renderArchive();prepareSettingsTab();updateNavOnScroll();switchTab('tab-input',$$('.nav-item')[0])}catch(e){console.error("Init failed:",e);fullReset()}}

function clearInput(id){const el=$(id);if(!el)return;el.value='';el.dispatchEvent(new Event('input'));el.focus()}
function performPhantomSwap(val){const parent=state.pointsDB.find(x=>x.synonyms.some(s=>(typeof s==='object'?s.name:s).toLowerCase()===val.toLowerCase()));if(parent){handlePointSelection(val);return!0}return!1}
function toggleAddressMode(forceVal){vibrate(10);const btn=$('btnToggleDiff'),block=$('diffAddressBlock'),isActive=(typeof forceVal==='boolean')?forceVal:!btn.classList.contains('active-diff');toggleCls(btn,'active-diff',isActive);toggleCls(block,'active',isActive);if(isActive&&!$('factAddressInput').value)setTimeout(()=>$('factAddressInput').focus(),100)}
function toggleTransitMode(forceVal){vibrate(10);const isActive=(typeof forceVal==='boolean')?forceVal:!$('btnToggleTransit').classList.contains('active-transit');toggleCls($('btnToggleTransit'),'active-transit',isActive)}

function handleMainAction(){vibrate();let pointName=$('pointInput').value.trim(),isDiff=$('btnToggleDiff').classList.contains('active-diff'),factAddr=isDiff?$('factAddressInput').value.trim():'';
    const phantom=state.pointsDB.find(x=>x.synonyms.some(s=>(typeof s==='object'?s.name:s).toLowerCase()===pointName.toLowerCase()));
    if(phantom){const old=pointName;pointName=phantom.name;isDiff=!0;factAddr=old;$('pointInput').value=pointName;toggleAddressMode(!0);$('factAddressInput').value=factAddr}
    const routeVal=$('routeSelect').value;if(!pointName)return showCustomAlert('–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');if(!routeVal)return showCustomAlert('–û—à–∏–±–∫–∞','–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!');
    const isTransit=$('btnToggleTransit').classList.contains('active-transit');
    const proceed=()=>{
        const entry={id:state.editingId||(Date.now()+Math.floor(Math.random()*1000)),name:pointName,route:routeVal,amounts:Array.from($$('.amount-row input')).map(i=>i.value.trim()).filter(Boolean).join(' / '),isTransit,isDiff,factAddr,note:$('noteInput').value.trim()};
        if(state.editingId){const idx=state.draft.findIndex(i=>i.id===state.editingId);if(idx!==-1)state.draft[idx]=entry;showCustomAlert('–ì–æ—Ç–æ–≤–æ','–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞')}else{state.draft.push(entry)}saveData();resetForm()
    };
    if(!state.pointsDB.find(x=>x.name.toLowerCase()===pointName.toLowerCase())){showCustomConfirm("–ù–æ–≤–∞—è —Ç–æ—á–∫–∞",`–°–æ—Ö—Ä–∞–Ω–∏—Ç—å "${pointName}" –≤ –±–∞–∑—É —Å –º–∞—Ä—à—Ä—É—Ç–æ–º ${routeVal}?`,"–î–∞, –∑–∞–ø–æ–º–Ω–∏—Ç—å","–ù–µ—Ç, —Ç–æ–ª—å–∫–æ –∑–∞—è–≤–∫–∞",()=>{state.pointsDB.push({id:Date.now()+Math.random().toString(36).substr(2,9),name:pointName,route:routeVal,isTransit,synonyms:[]});state.pointsDB.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:!0}));saveData();showToast("‚úÖ –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");proceed()},()=>proceed())}else{proceed()}
}

function showCustomConfirm(title,text,okLabel,cancelLabel,onOk,onCancel){vibrate(30);$('cmTitle').textContent=title;$('cmText').textContent=text;$('cmInput').style.display='none';const btns=$('cmButtons');btns.innerHTML='';
    const btnCancel=document.createElement('button');btnCancel.className='cm-btn cm-cancel';btnCancel.textContent=cancelLabel;btnCancel.onclick=()=>{vibrate(10);closeCustomModal();if(onCancel)onCancel()};
    const btnOk=document.createElement('button');btnOk.className='cm-btn cm-confirm';btnOk.textContent=okLabel;btnOk.onclick=()=>{vibrate(10);closeCustomModal();onOk()};btns.append(btnCancel,btnOk);$('customModal').classList.add('active')}

function resetForm(){$('pointInput').value='';$('factAddressInput').value='';$('noteInput').value='';renderAmountInputs([]);$('routeSelect').value='';
    toggleCls($('btnToggleDiff'),'active-diff',!1);toggleCls($('diffAddressBlock'),'active',!1);toggleCls($('btnToggleTransit'),'active-transit',!1);
    highlightActiveNotes('');state.editingId=null;$('mainActionBtn').textContent='–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫';$('cancelEditBtn').style.display='none';$('editModeBanner').style.display=state.archiveEditId?'flex':'none';updateSelectButtons();
    $('mappingHintBlock').classList.remove('active','warning');$('btnResetContext').style.display='none';state.originalContext={hasRule:!1,route:null,isTransit:null,isDiff:null,factAddr:null};renderDraft()}

function renderDraft(){const list=$('draftList'),count=state.draft.length;$('draftCount').textContent=count;const badge=$('navBadge');badge.textContent=count;badge.style.display=count>0?'flex':'none';if(count>0){badge.style.animation='none';badge.offsetHeight;badge.style.animation='popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'}$('archiveBtn').style.display=(count>0||state.archiveEditId)?'flex':'none';list.innerHTML='';if(count===0){list.innerHTML=`<div class="empty-state">${state.archiveEditId?'–ê—Ä—Ö–∏–≤ –æ—á–∏—â–µ–Ω':'–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç<br><small style="opacity:0.6">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ù–æ–≤–∞—è"</small>'}</div>`;return}state.draft.forEach((item,index)=>{const el=document.createElement('div');el.className=`card ${state.editingId===item.id?'editing-focus':''}`;el.dataset.id=item.id;
    let mainTags=`<span class="u-tag tag-route">${item.route}</span>`+(item.isTransit?`<span class="u-tag tag-transit">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</span>`:'');
    el.innerHTML=`<div class="card-top"><div class="card-title">üìÑ ${item.name}</div>${item.amounts?`<span class="u-tag tag-amount" style="margin:0">${item.amounts}</span>`:`<span class="u-tag tag-amount empty" style="margin:0">–ù–ï–¢ –°–£–ú–ú–´</span>`}</div><div class="card-tags">${mainTags}</div>${(item.isDiff&&item.factAddr)?`<div style="margin-top: 8px;"><span class="u-tag tag-address">üìç ${item.factAddr}</span></div>`:''}${item.note?`<div class="card-note" style="margin-top:8px">‚ÑπÔ∏è ${item.note}</div>`:''}`;setupDragItem(el,item,index);list.appendChild(el)});try{renderReports()}catch(e){}}

function cancelArchiveEdit(){showCustomConfirm('–í—ã—Ö–æ–¥','–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –ø—Ä–∞–≤–∫–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?','–í—ã–π—Ç–∏','–û—Ç–º–µ–Ω–∞',()=>exitArchiveEditMode())}
function loadForEdit(id){const item=state.draft.find(i=>i.id===id);if(!item)return;state.editingId=id;$('pointInput').value=item.name;renderAmountInputs(item.amounts?item.amounts.split(' / '):[]);$('routeSelect').value=item.route;toggleTransitMode(!!item.isTransit);if(item.isDiff){toggleAddressMode(!0);$('factAddressInput').value=item.factAddr}else{toggleAddressMode(!1)}$('noteInput').value=item.note||'';highlightActiveNotes(item.note||'');updateSelectButtons();$('mainActionBtn').textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';$('cancelEditBtn').style.display='block';switchTab('tab-input',$$('.nav-item')[0])}
function saveToArchive(){if(!state.draft.length)return;vibrate(40);if(state.archiveEditId)return handleUpdateArchive();showCustomConfirm('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–Ω—è','–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ –∞—Ä—Ö–∏–≤?','–ó–∞–≤–µ—Ä—à–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{state.archive.unshift({id:Date.now(),date:new Date().toLocaleDateString()+', '+new Date().toLocaleTimeString().slice(0,5),items:[...state.draft]});state.draft=[];saveData();renderArchive();resetForm();switchTab('tab-archive',$$('.nav-item')[3])})}
function renderArchive(){const c=$('archiveContainer');c.innerHTML='';if(state.archive.length===0){c.innerHTML='<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';return}state.archive.forEach(rec=>{const div=document.createElement('div');div.className='ac-card';if(state.archiveEditId===rec.id)div.classList.add('editing-focus');const groups={};rec.items.forEach(i=>{if(!groups[i.route])groups[i.route]=[];groups[i.route].push(i)});let contentHtml='';Object.keys(groups).sort().forEach(r=>{contentHtml+=`<div class="settings-header" style="margin:20px 16px 8px 16px; color:#6b7280; font-size:10px;">${r}</div>`;groups[r].forEach(item=>{contentHtml+=`<div class="card"><div class="card-top"><div class="card-title">üìÑ ${item.name}</div>${item.amounts?`<span class="u-tag tag-amount" style="margin:0">${item.amounts}</span>`:`<span class="u-tag tag-amount empty" style="margin:0">–ù–ï–¢ –°–£–ú–ú–´</span>`}</div><div class="card-tags"><span class="u-tag tag-route">${item.route}</span>${item.isTransit?`<span class="u-tag tag-transit">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</span>`:''}</div>${(item.isDiff&&item.factAddr)?`<div style="margin-top: 8px;"><span class="u-tag tag-address">üìç ${item.factAddr}</span></div>`:''}${item.note?`<div class="card-note" style="margin-top:8px">‚ÑπÔ∏è ${item.note}</div>`:''}</div>`})});div.innerHTML=`<div class="ac-header" ontouchstart="startPress(${rec.id})" ontouchend="endPress()" onmousedown="startPress(${rec.id})" onmouseup="endPress()" onmouseleave="endPress()" onclick="handleArchiveHeaderClick(this)"><div class="ac-date">üìÖ ${rec.date}</div><div class="badge-counter" style="background:#333">${rec.items.length}</div></div><div class="ac-body">${contentHtml}<div style="height:12px;"></div></div>`;c.appendChild(div)})}
function editArchiveRecord(id){const rec=state.archive.find(r=>r.id===id);if(!rec)return;if(state.draft.length>0)state.stash=[...state.draft];state.archiveEditId=id;state.draft=[...rec.items];$('editModeBanner').style.display='flex';$('archiveBtn').innerHTML='<span>üíæ</span> –û–ë–ù–û–í–ò–¢–¨ –ê–†–•–ò–í';$('cancelArchiveEditBtn').style.display='block';saveData();renderDraft();switchTab('tab-list',$$('.nav-item')[1])}
function handleUpdateArchive(){showCustomConfirm('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ','–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏–≤–µ?','–°–æ—Ö—Ä–∞–Ω–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{const idx=state.archive.findIndex(r=>r.id===state.archiveEditId);if(idx!==-1){state.archive[idx].items=[...state.draft]}exitArchiveEditMode()})}
function exitArchiveEditMode(){state.archiveEditId=null;state.draft=state.stash.length?[...state.stash]:[];state.stash=[];$('editModeBanner').style.display='none';$('archiveBtn').innerHTML='<span>üèÅ</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å';$('cancelArchiveEditBtn').style.display='none';saveData();renderDraft();renderArchive();switchTab('tab-archive',$$('.nav-item')[3])}
function deleteArchiveRecord(id){showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ','–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?','–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{state.archive=state.archive.filter(r=>r.id!==id);saveData();renderArchive()})}
function clearAllArchive(){vibrate(50);showCustomConfirm('–û—á–∏—Å—Ç–∫–∞','–£–¥–∞–ª–∏—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é?','–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë','–û—Ç–º–µ–Ω–∞',()=>{state.archive=[];saveData();renderArchive()})}

function prepareSettingsTab(){$('settingRoutes').value=state.refRoutes.join(', ');$('settingNotes').value=state.refNotes.join(', ');updateBadgesFromInputs();tempHints={...state.routeHints};tempContacts=JSON.parse(JSON.stringify(state.contacts||{operator:[],expeditor:[]}));tempPointsDB=JSON.parse(JSON.stringify(state.pointsDB));updateSelectButtons();checkSettingsDirty()}
function saveSettings(){vibrate();state.refRoutes=parseList($('settingRoutes').value);state.refNotes=parseList($('settingNotes').value);state.routeHints={...tempHints};state.contacts=JSON.parse(JSON.stringify(tempContacts));state.pointsDB=JSON.parse(JSON.stringify(tempPointsDB));saveData();renderRefLists();renderDraft();const btn=$('saveSettingsBtn');btn.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! ‚úî';checkSettingsDirty();setTimeout(()=>{if(btn.disabled)btn.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'},2000);prepareSettingsTab()}
function checkSettingsDirty(){
    const btnSave=$('saveSettingsBtn'),btnCancel=$('cancelSettingsBtn'),sortStr=a=>[...a].sort((a,b)=>a.localeCompare(b,undefined,{numeric:!0})),listDirty=(a,b)=>JSON.stringify(sortStr(a))!==JSON.stringify(sortStr(b)),sortDb=d=>[...d].sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:!0}));
    const hasChanges=listDirty(parseList($('settingRoutes').value),state.refRoutes)||listDirty(parseList($('settingNotes').value),state.refNotes)||JSON.stringify(state.routeHints)!==JSON.stringify(tempHints)||JSON.stringify(state.contacts)!==JSON.stringify(tempContacts)||JSON.stringify(sortDb(state.pointsDB))!==JSON.stringify(sortDb(tempPointsDB));
    btnSave.disabled=!hasChanges;toggleCls(btnSave,'dirty',hasChanges);btnSave.textContent=hasChanges?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏':btnSave.textContent;btnCancel.style.display=hasChanges?'block':'none'}

function renderReports(){
    if(!state.draft||!state.draft.length){$('reportOperator').textContent='(–ü—É—Å—Ç–æ)';$('reportExpeditor').textContent='(–ü—É—Å—Ç–æ)';return}
    try{
        const fmt=s=>s?s.split('/').map(x=>x.trim().replace(/\s/g,'')+'~').join(' / '):'', opText=state.draft.map(i=>`${i.name} | ${i.amounts?fmt(i.amounts).replace(/~/g,'')+' | ':''}${i.route}`).join('\n\n');$('reportOperator').textContent=opText||'(–ü—É—Å—Ç–æ)';
        const groups={},unk="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç";state.draft.forEach(i=>{const r=i.route||unk;if(!groups[r])groups[r]=[];groups[r].push(i)});
        const sortedKeys=Object.keys(groups).sort((a,b)=>{if(a===unk)return 1;if(b===unk)return-1;const iA=state.refRoutes.indexOf(a),iB=state.refRoutes.indexOf(b);return(iA===-1&&iB===-1)?a.localeCompare(b):(iA===-1?1:(iB===-1?-1:iA-iB))});
        let expText='';sortedKeys.forEach(r=>{expText+=`=== ${r} ===\n\n`+groups[r].map(i=>`üìÑ ${i.name}${i.isDiff?` ‚ûú üìç ${i.factAddr}`:''}\n ‚ï†‚ïêüó∫ ${i.route||'?'}${i.isTransit?' [–°–∫–ª–∞–¥/–û—Ñ–∏—Å]':''}${i.amounts?`\n ‚ï†‚ïêüí∞ ${fmt(i.amounts)}`:''}${i.note?`\n ‚ïö‚ïê‚ÑπÔ∏è ${i.note}`:''}`).join('\n\n')+'\n\n'});$('reportExpeditor').textContent=expText.trim()||'(–ü—É—Å—Ç–æ)'
    }catch(e){console.error(e);$('reportExpeditor').textContent="–û—à–∏–±–∫–∞: "+e.message}
}
function copyReportText(text){if(!text)return;const s=()=>{vibrate([30,50,30]);showCustomAlert('–ì–æ—Ç–æ–≤–æ','–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä!')};if(navigator.clipboard?.writeText)navigator.clipboard.writeText(text).then(s).catch(console.error);else{const t=document.createElement("textarea");t.value=text;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);s()}}
function loadData(){state.draft=DB.get('tp_currentDraft');state.archive=DB.get('tp_tradeArchive');state.pointsDB=DB.get('tp_pointsDB');state.refRoutes=DB.get('tp_myRoutes',DEFAULTS.routes);state.refNotes=DB.get('tp_myNotes',DEFAULTS.notes);state.routeHints=DB.get('tp_routeHints',DEFAULT_HINTS);state.stash=DB.get('tp_stash');state.contacts=DB.get('tp_contacts',{operator:[],expeditor:[]})}

function saveData() {
    DB.set('tp_currentDraft', state.draft);
    DB.set('tp_tradeArchive', state.archive);
    DB.set('tp_pointsDB', state.pointsDB);
    DB.set('tp_myRoutes', state.refRoutes);
    DB.set('tp_myNotes', state.refNotes);
    DB.set('tp_routeHints', state.routeHints);
    DB.set('tp_stash', state.stash);
    DB.set('tp_contacts', state.contacts);
}

function setupAutocomplete(inputId,listId,_ignored){
    const input=$(inputId),list=$(listId),doSearch=()=>{
        const code=getSearchCode(input.value);list.innerHTML='';if(!input.value){list.style.display='none';return}
        const syns=new Set();state.pointsDB.forEach(p=>p.synonyms.forEach(s=>syns.add((typeof s==='object'?s.name:s).toLowerCase())));
        let res=[];state.pointsDB.forEach(p=>{
            if(getSearchCode(p.name).includes(code)&&!syns.has(p.name.toLowerCase()))res.push({type:'main',text:p.name,obj:p});
            p.synonyms.forEach(s=>{const sName=typeof s==='object'?s.name:s;if(getSearchCode(sName).includes(code))res.push({type:'syn',text:sName,parent:p,childData:s})})
        });
        if(res.length){list.style.display='block';vibrate();res.slice(0,10).forEach(m=>{const d=document.createElement('div');d.className='autocomplete-item';d.innerHTML=inputId==='pointInput'?(m.type==='syn'?`üìç ${m.text} <span class="ghost-hint">‚ûú üìÑ ${m.parent.name}</span>`:`üìÑ ${m.text}`):m.text;d.onclick=()=>{vibrate(15);list.style.display='none';if(inputId==='pointInput')handlePointSelection(m.text);else{input.value=m.text;input.dispatchEvent(new Event('input'))}};list.appendChild(d)})}else list.style.display='none'
    };input.addEventListener('input',doSearch);input.addEventListener('focus',doSearch);input.addEventListener('blur',()=>{setTimeout(()=>{list.style.display='none'},200)})
}
function handlePointSelection(val){
    const v=val.toLowerCase(),p=state.pointsDB.find(x=>x.synonyms.some(s=>(typeof s==='object'?s.name:s).toLowerCase()===v)),hint=$('mappingHintBlock');
    hint.classList.remove('warning');$('btnResetContext').style.display='none';
    if(p){const c=p.synonyms.find(s=>(typeof s==='object'?s.name:s).toLowerCase()===v);
        $('pointInput').value=p.name;$('factAddressInput').value=typeof c==='object'?c.name:c;toggleAddressMode(!0);
        toggleCls($('pointInput'),'flash-field',!0);toggleCls($('factAddressInput'),'flash-field',!0);
        $('hintTitle').textContent="–ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞";$('mappingHintText').innerHTML=`–ù–∞–∫–ª–∞–¥–Ω–∞—è: <b>${p.name}</b><br>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å: <b>${typeof c==='object'?c.name:c}</b>`;
        hint.classList.add('active');applyRulesAndContext(typeof c==='object'&&c.route?{...c,isTransit:c.isTransit??p.isTransit}:p,!0,typeof c==='object'?c.name:c)}
    else{$('pointInput').value=val;$('factAddressInput').value='';toggleAddressMode(!1);hint.classList.remove('active');applyRulesAndContext(state.pointsDB.find(x=>x.name.toLowerCase()===v),!1,val)}
}
function showToast(txt){const t=document.createElement('div');t.className='toast-notification';t.innerHTML=txt;document.body.appendChild(t);setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},2500)}
function checkRouteBinding(val,expl){const v=val.trim().toLowerCase(),db=expl||state.pointsDB.find(x=>x.name.toLowerCase()===v||x.synonyms.some(s=>(typeof s==='object'?s.name:s).toLowerCase()===v));
    const isPh=db&&db.synonyms.some(s=>(typeof s==='object'?s.name:s).toLowerCase()===v);applyRulesAndContext(db,isPh,v,!0);
    if(db){if(isPh){toggleAddressMode(!0);if($('factAddressInput').value.trim().toLowerCase()!==v)$('factAddressInput').value=val}else{toggleAddressMode(!1);$('factAddressInput').value='';$('mappingHintBlock').classList.remove('active')}}
    else{toggleAddressMode(!1);$('factAddressInput').value='';$('mappingHintBlock').classList.remove('active');$('btnResetContext').style.display='none'}checkContextDifferences()
}
function checkContextDifferences(){
    const curR=$('routeSelect').value,curT=$('btnToggleTransit').classList.contains('active-transit'),curD=$('btnToggleDiff').classList.contains('active-diff'),curA=$('factAddressInput').value.trim();
    const orig=state.originalContext,blk=$('mappingHintBlock'),tit=$('hintTitle'),txt=$('mappingHintText'),btn=$('btnResetContext');
    if(!orig||!orig.hasRule){blk.classList.remove('active','warning');return}
    const dR=curR!==orig.route,dT=curT!==orig.isTransit,dA=orig.isDiff?(!curD||curA.toLowerCase()!==orig.factAddr.toLowerCase()):curD;
    blk.classList.add('active');
    if(dR||dT||dA){blk.classList.add('warning');tit.textContent="‚ö†Ô∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï –ü–†–ê–í–ò–õ";blk.querySelector('.hint-icon').textContent="‚ö†Ô∏è";txt.innerHTML=(dR?`–ú–∞—Ä—à—Ä—É—Ç: <s>${orig.route||'–ù–µ—Ç'}</s> ‚ûú <b>${curR||'–ù–µ—Ç'}</b><br>`:'')+(dT?`–¢—Ä–∞–Ω–∑–∏—Ç: <s>${orig.isTransit?'–î–∞':'–ù–µ—Ç'}</s> ‚ûú <b>${curT?'–î–∞':'–ù–µ—Ç'}</b><br>`:'')+(dA?`–ê–¥—Ä–µ—Å: <s>${orig.isDiff?orig.factAddr:'–ù–µ—Ç'}</s> ‚ûú <b>${curD?curA:'–û—Ç–∫–ª'}</b><br>`:'');btn.style.display='inline-flex';btn.innerHTML="‚Ü∫ –í–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –≤ –±–∞–∑–µ"}
    else{blk.classList.remove('warning');tit.textContent="üìã –ü–†–ê–í–ò–õ–ê –¢–û–ß–ö–ò (–ò–ó –ë–ê–ó–´)";blk.querySelector('.hint-icon').textContent="‚ÑπÔ∏è";btn.style.display='none';txt.innerHTML=`–ú–∞—Ä—à—Ä—É—Ç: <span class="rule-tag">${orig.route||'–ù–µ –∑–∞–¥–∞–Ω'}</span>${orig.isTransit?' &nbsp;–¢—Ä–∞–Ω–∑–∏—Ç: <span class="rule-tag">–î–∞</span>':''}`+(orig.isDiff?`<div class="repl-container"><div class="repl-header">üîÑ –ê–≤—Ç–æ-–∑–∞–º–µ–Ω–∞</div><div class="repl-flow"><span class="val-fact">üìç ${orig.factAddr}</span><span class="val-arrow">‚ûú</span><span class="val-invoice">üìÑ ${$('pointInput').value}</span></div></div>`:'')}
}
function resetToOriginalContext(){vibrate(20);const o=state.originalContext;if(o.route){$('routeSelect').value=o.route;updateSelectButtons()}toggleTransitMode(!!o.isTransit);toggleAddressMode(o.isDiff);if(o.isDiff)$('factAddressInput').value=o.factAddr||'';checkContextDifferences()}
function applyRulesAndContext(db,isPh,addr,skip){const r=db?.route||"",t=!!db?.isTransit;$('routeSelect').value=r;toggleTransitMode(t);state.originalContext={hasRule:!!db,route:r,isTransit:t,isDiff:isPh,factAddr:isPh?addr:""};updateSelectButtons();if(!skip)checkContextDifferences()}
function showCustomModal(t,txt,btns){vibrate(30);$('cmTitle').textContent=t;$('cmText').textContent=txt;$('cmInput').style.display='none';const bC=$('cmButtons');bC.innerHTML='';btns.forEach(b=>{const el=document.createElement('button');el.className=`cm-btn ${b.cls}`;el.textContent=b.txt;el.onclick=b.action?()=>{vibrate(10);closeCustomModal();b.action()}:()=>{vibrate(10);closeCustomModal()};bC.appendChild(el)});$('customModal').classList.add('active')}
const showCustomAlert=(t,tx)=>showCustomModal(t,tx,[{txt:'–û–ö',cls:'cm-confirm'}]), closeCustomModal=()=>$('customModal').classList.remove('active');
function openRouteSheet(){
    vibrate();
    $('bsHeader').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç';
    $('bsContent').innerHTML = '';
    const curVal = $('routeSelect').value;
    state.refRoutes.forEach(r => {
        const hint = state.routeHints[r] || '–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏';
        const d = document.createElement('div');
        d.className = 'bs-item route-split-item';
        if(r === curVal) d.classList.add('selected');
        d.innerHTML = `<div class="rsi-left">${r}</div><div class="rsi-divider"></div><div class="rsi-right">${hint}</div>`;
        d.onclick = () => {
            vibrate(10);
            $('routeSelect').value = r;
            updateSelectButtons();
            checkContextDifferences();
            closeBottomSheet();
        };
        $('bsContent').appendChild(d);
    });
    $('bottomSheet').classList.add('active');
}
function openBottomSheet(items,cb,title,sel){vibrate();$('bsHeader').textContent=title;$('bsContent').innerHTML='';items.forEach(i=>{const d=document.createElement('div');d.className='bs-item';d.textContent=i;if(i===sel)d.classList.add('selected');d.onclick=()=>{vibrate(10);cb(i);closeBottomSheet()};$('bsContent').appendChild(d)});$('bottomSheet').classList.add('active')}
function closeBottomSheet(e){if(!e||e.target.classList.contains('bs-overlay')){$('bottomSheet').classList.remove('active');$('bsPanel').style.transform='';$('bsContent').classList.remove('no-scroll');if(document.activeElement)document.activeElement.blur()}}
function openNoteSheet(){vibrate();$('bsHeader').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è';$('bsContent').innerHTML='<div id="sheetChipsWrapper" class="chips-wrapper" style="max-height:none;justify-content:flex-start;margin-bottom:20px;"></div>';const wr=$('sheetChipsWrapper'),cur=$('noteInput').value.split(',').map(s=>s.trim().toLowerCase());state.refNotes.forEach(n=>{const c=document.createElement('div');c.className='chip';c.style.cssText="padding:8px 16px;font-size:14px;";c.textContent=n;if(cur.includes(n.toLowerCase()))c.classList.add('active');c.onclick=()=>{vibrate(10);toggleNoteValue(n)};wr.appendChild(c)});const b=document.createElement('button');b.className='btn-common btn-main';b.textContent='–ì–æ—Ç–æ–≤–æ / –ó–∞–∫—Ä—ã—Ç—å';b.onclick=()=>$('bottomSheet').classList.remove('active');$('bsContent').appendChild(b);$('bottomSheet').classList.add('active')}
function toggleNoteValue(n){const i=$('noteInput'),p=parseList(i.value),idx=p.findIndex(x=>x.toLowerCase()===n.toLowerCase());if(idx>=0)p.splice(idx,1);else p.push(n);i.value=p.join(', ');i.dispatchEvent(new Event('input'))}
function renderAmountInputs(v){$('amountsContainer').innerHTML='';v.forEach(addAmountInputToDom)}
function addAmountField(){vibrate();const i=addAmountInputToDom('');if(i)i.focus()}
function addAmountInputToDom(v){const d=document.createElement('div');d.className='amount-row';d.innerHTML=`<input type="number" placeholder="–°—É–º–º–∞" value="${v}"><button class="btn-remove" onclick="vibrate();this.parentElement.remove()">‚úï</button>`;$('amountsContainer').appendChild(d);return d.querySelector('input')}
function updateSelectButtons(){const v=$('routeSelect').value,b=$('routeSelectBtn');b.textContent=v||'–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...';b.style.color=v?'var(--text-main)':'var(--text-muted)';b.style.opacity=v?'1':'0.7'}
function highlightActiveNotes(v){const p=v.split(',').map(s=>s.trim().toLowerCase());$$('#sheetChipsWrapper .chip').forEach(c=>toggleCls(c,'active',p.includes(c.textContent.toLowerCase())))}
function importDb(inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(!d.settings||!d.archive)throw new Error;showCustomConfirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ','–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É?','–ó–∞–º–µ–Ω–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{DB.set('tp_currentDraft',d.draft||[]);DB.set('tp_tradeArchive',d.archive||[]);DB.set('tp_pointsDB',d.settings.pointsDB||[]);DB.set('tp_myRoutes',d.settings.refRoutes);DB.set('tp_myNotes',d.settings.refNotes);DB.set('tp_routeHints',d.settings.routeHints);DB.set('tp_contacts',d.settings.contacts||{operator:[],expeditor:[]});location.reload()})}catch{showCustomAlert('–û—à–∏–±–∫–∞','–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª')}};r.readAsText(f);inp.value=''}
function fullReset(){vibrate([50,100,50]);showCustomConfirm('–°–±—Ä–æ—Å','–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?','–°–ë–†–û–°–ò–¢–¨','–û—Ç–º–µ–Ω–∞',()=>{localStorage.clear();location.reload()})}
function deleteItem(i){showCustomConfirm('–£–¥–∞–ª–∏—Ç—å','–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?','–î–∞','–ù–µ—Ç',()=>{state.draft.splice(i,1);saveData();renderDraft()})}
function duplicateItem(i){state.draft.splice(i+1,0,{...state.draft[i],id:Date.now()});saveData();renderDraft()}
function changeArchiveTime(id){const p=$('archiveDatePicker'),rec=state.archive.find(r=>r.id===id);if(!rec)return;try{const[d,t]=rec.date.split(', '), [dd,mm,yy]=d.split('.');p.value=`${yy}-${mm}-${dd}T${t}`}catch{}p.onchange=function(){if(this.value){const d=new Date(this.value);rec.date=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}, ${d.toLocaleTimeString().slice(0,5)}`;state.archive.sort((a,b)=>{const pd=s=>{const[D,T]=s.split(', '), [dx,mx,yx]=D.split('.');return new Date(`${yx}-${mx}-${dx}T${T}`).getTime()};return pd(b.date)-pd(a.date)});saveData();renderArchive();showCustomAlert('–ì–æ—Ç–æ–≤–æ','–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞.')}};try{p.showPicker()}catch{p.click()}}
function renderRefLists(){const s=$('routeSelect'),o=s.value;s.innerHTML='<option value="" disabled selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';state.refRoutes.forEach(i=>s.add(new Option(i,i)));if(o&&state.refRoutes.includes(o))s.value=o;else s.value='';updateSelectButtons();}
function revertSettings(){prepareSettingsTab();tempHints={...state.routeHints};tempContacts=JSON.parse(JSON.stringify(state.contacts||{operator:[],expeditor:[]}));tempPointsDB=JSON.parse(JSON.stringify(state.pointsDB));updateBadgesFromInputs();showCustomAlert('–°–±—Ä–æ—à–µ–Ω–æ','–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.');checkSettingsDirty()}
function handleSendReport(t){const txt=$(`report${t.charAt(0).toUpperCase()+t.slice(1)}`).textContent,c=state.contacts[t]||[];if(!txt||txt==='(–ü—É—Å—Ç–æ)')return showCustomAlert('–ü—É—Å—Ç–æ','–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');if(!c.length)return showCustomAlert('–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤',`–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.`);if(c.length===1)sendToWhatsapp(c[0].phone,txt);else{const ct=$('bsContent');$('bsHeader').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è';ct.innerHTML='';c.forEach(i=>{const b=document.createElement('button');b.className='bs-item';b.innerHTML=`<span>${i.name}</span> <span style="font-size:12px;color:#888;">${i.phone}</span>`;b.onclick=()=>{sendToWhatsapp(i.phone,txt);$('bottomSheet').classList.remove('active')};ct.appendChild(b)});$('bottomSheet').classList.add('active');vibrate()}}
function sendToWhatsapp(p,t){let n=p.replace(/\D/g,'');if(n.length===11&&n.startsWith('8'))n='7'+n.slice(1);if(n.length===10)n='7'+n;window.open(`https://wa.me/${n}?text=${encodeURIComponent(t)}`,'_blank')}

function setupBottomSheetSwipe(){
    $$('.bs-panel').forEach(p=>{let sy=0,drag=false,scroll=false;const c=p.querySelector('.bs-content');
        p.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;drag=!!(e.target.closest('.bs-header')||e.target.closest('.bs-static-top'));if(drag)p.style.transition='none'},{passive:!1});
        p.addEventListener('touchmove',e=>{const y=e.touches[0].clientY,d=y-sy,st=(p.querySelector('.bs-scroll-part')||c)?.scrollTop||0;if(drag){e.preventDefault();p.style.transform=`translateY(${d>0?d:0}px)`;return}if(scroll)return;if(d>0&&st<=0){drag=true;scroll=false;p.style.transition='none';e.preventDefault()}else{scroll=true;drag=false}},{passive:!1});
        p.addEventListener('touchend',e=>{p.style.transition='transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1)';p.style.transform='';if(drag&&(e.changedTouches[0].clientY-sy)>120){const o=p.closest('.bs-overlay');if(o){o.classList.remove('active');if(c)c.classList.remove('no-scroll');document.activeElement.blur()}}drag=false;scroll=false})})}

const track=$('swipeTrack'),TABS=['tab-input','tab-list','tab-reports','tab-archive','tab-settings'],NAV_ITEMS=$$('.nav-item');
let navPill=document.querySelector('.nav-pill')||document.querySelector('.bottom-nav').appendChild(document.createElement('div')),currentIndex=0,isRestoring=!1,isTicking=!1;
function updateNavOnScroll(){if(isRestoring){isTicking=!1;return}const w=track.offsetWidth,sl=track.scrollLeft,p=sl/w;if(!w){isTicking=!1;return}
    navPill.className='nav-pill';navPill.style.transform=`translate3d(${p*100}%,0,0)`;
    NAV_ITEMS.forEach((b,i)=>{const ico=b.querySelector('.nav-icon'),dist=Math.abs(p-i),str=Math.max(0,1-dist);if(ico)ico.style.transform=`translateY(${-4*str}px) scale(${1+str*0.15})`;b.style.color=`rgb(${Math.round(156+(59-156)*str)},${Math.round(163+(130-163)*str)},${Math.round(175+(246-175)*str)})`});
    const ni=Math.round(p);if(ni!==currentIndex){if(currentIndex===4&&ni!==4&&$('saveSettingsBtn')?.classList.contains('dirty')){if(document.querySelector('.custom-modal.active')){track.scrollTo({left:4*w,behavior:'auto'});isTicking=!1;return}isRestoring=!0;track.scrollTo({left:4*w,behavior:'auto'});showCustomConfirm('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–∞–¥—É—Ç.','–°–±—Ä–æ—Å–∏—Ç—å –∏ —É–π—Ç–∏','–û—Å—Ç–∞—Ç—å—Å—è',()=>{revertSettings();isRestoring=!1;goToTab(ni,!0)});isTicking=!1;return}
    currentIndex=ni;NAV_ITEMS.forEach(b=>b.classList.remove('active'));if(NAV_ITEMS[currentIndex])NAV_ITEMS[currentIndex].classList.add('active');if(document.activeElement?.tagName==='INPUT')document.activeElement.blur();try{if(TABS[currentIndex]==='tab-reports')renderReports();if(TABS[currentIndex]==='tab-settings')prepareSettingsTab()}catch{}vibrate(5)}isTicking=!1}
track.addEventListener('scroll',()=>{if(!isTicking){window.requestAnimationFrame(updateNavOnScroll);isTicking=!0}},{passive:!0});
function goToTab(i,f){if(!f&&currentIndex===4&&i!==4&&$('saveSettingsBtn')?.classList.contains('dirty')){showCustomConfirm('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–∞–¥—É—Ç.','–°–±—Ä–æ—Å–∏—Ç—å –∏ —É–π—Ç–∏','–û—Å—Ç–∞—Ç—å—Å—è',()=>{revertSettings();isRestoring=!1;goToTab(i,!0)});return}track.scrollTo({left:i*track.offsetWidth,behavior:'smooth'})}
window.switchTab=(id)=>goToTab(TABS.indexOf(id));
const startPress=id=>{isLongPress=!1;pressTimer=setTimeout(()=>{isLongPress=!0;openArchiveContextMenu(id)},600)}, endPress=el=>{clearTimeout(pressTimer);(el||document.querySelector('.ac-card.pressed'))?.classList.remove('pressed')}, handleArchiveHeaderClick=el=>{if(!isLongPress){vibrate(10);el.nextElementSibling.classList.toggle('open')}};

function openItemContextMenu(id,idx,item){$('bsContent').innerHTML='';
    [{txt:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',icon:'‚úèÔ∏è',action:()=>loadForEdit(id),w:1},{txt:'–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é',icon:'üìÑ',action:()=>duplicateItem(idx)},{txt:'–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç',icon:'üìã',action:()=>copyReportText(`${item.name} | ${item.amounts?item.amounts+' | ':''}${item.route}`)},{txt:'–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É',icon:'üóë',action:()=>deleteItem(idx),d:1}].forEach(i=>{
        const b=document.createElement('button');b.className=`bs-action-btn ${i.d?'danger':''}`;b.innerHTML=`<span ${i.w?'style="color:var(--warning)"':''}>${i.icon}</span> ${i.w?'<b>'+i.txt+'</b>':i.txt}`;b.onclick=()=>{vibrate(10);i.action();closeBottomSheet()};$('bsContent').appendChild(b)});$('bsHeader').textContent=item.name;$('bottomSheet').classList.add('active');vibrate()}
function openArchiveContextMenu(id){const r=state.archive.find(x=>x.id===id);if(!r)return;$('bsContent').innerHTML='';
    [{txt:'–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É/–≤—Ä–µ–º—è',icon:'üïí',action:()=>changeArchiveTime(id)},{txt:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º',icon:'‚úèÔ∏è',action:()=>editArchiveRecord(id),w:1},{txt:'–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å',icon:'üóë',action:()=>deleteArchiveRecord(id),d:1}].forEach(i=>{
        const b=document.createElement('button');b.className=`bs-action-btn ${i.d?'danger':''}`;b.innerHTML=`<span ${i.w?'style="color:var(--warning)"':''}>${i.icon}</span> ${i.w?'<b>'+i.txt+'</b>':i.txt}`;b.onclick=()=>{vibrate(10);i.action();closeBottomSheet()};$('bsContent').appendChild(b)});$('bsHeader').textContent=`–ê—Ä—Ö–∏–≤: ${r.date}`;$('bottomSheet').classList.add('active');vibrate()}

function setupKeyboardBehavior(){const vp=window.visualViewport;let ih=window.innerHeight;window.addEventListener('resize',()=>{if(!document.body.classList.contains('keyboard-open')&&window.innerHeight>ih)ih=window.innerHeight});
    const check=()=>vp?vp.height<(ih*0.8):!1, center=()=>{const el=document.activeElement;if(el?.tagName==='INPUT'||el?.tagName==='TEXTAREA')setTimeout(()=>el.scrollIntoView({behavior:'smooth',block:'center'}),100)};
    if(vp){vp.addEventListener('resize',()=>{const open=check();toggleCls(document.body,'keyboard-open',open);if(open)center()});vp.addEventListener('scroll',()=>{const open=check();toggleCls(document.body,'keyboard-open',open)})}
    $$('input, textarea').forEach(i=>{i.addEventListener('focus',()=>{setTimeout(()=>{if(check()||window.innerHeight<ih*0.8){document.body.classList.add('keyboard-open');center()}},300)});i.addEventListener('blur',()=>{setTimeout(()=>{if(!check())document.body.classList.remove('keyboard-open')},100)})})}

let dragTimer=null,dragClone=null,dragSrcEl=null,isDrag=!1,startX=0,startY=0,lastTouchY=0,scrollInterval=null,scrollSpeed=0;
function setupDragItem(el,item,idx){el.addEventListener('touchstart',e=>hStart(e,el),{passive:!1});el.addEventListener('touchmove',hMove,{passive:!1});el.addEventListener('touchend',hEnd);el.addEventListener('mousedown',e=>hStart(e,el));el.addEventListener('mousemove',hMove);el.addEventListener('mouseup',hEnd)}
function hStart(e,el){if(e.button===2||(e.touches&&e.touches.length>1))return;isDrag=!1;dragSrcEl=el;startX=e.touches?e.touches[0].clientX:e.clientX;startY=e.touches?e.touches[0].clientY:e.clientY;clearTimeout(dragTimer);dragTimer=setTimeout(()=>{isDrag=!0;vibrate(50);document.body.classList.add('dragging-active');const r=el.getBoundingClientRect();dragClone=el.cloneNode(!0);dragClone.classList.add('card-clone');dragClone.style.width=r.width+'px';dragClone.style.height=r.height+'px';dragClone.style.top=r.top+'px';dragClone.style.left=r.left+'px';document.body.appendChild(dragClone);el.classList.add('is-dragging-placeholder')},400)}
function hMove(e){if(!dragSrcEl)return;const y=e.touches?e.touches[0].clientY:e.clientY,x=e.touches?e.touches[0].clientX:e.clientX;lastTouchY=y;if(!isDrag){if(Math.abs(y-startY)>6||Math.abs(x-startX)>6){clearTimeout(dragTimer);dragSrcEl=null}return}if(e.cancelable)e.preventDefault();
    if(dragClone){dragClone.style.top=`${y-dragClone.offsetHeight/2}px`;dragClone.style.left=`${x-dragClone.offsetWidth/2}px`;dragClone.style.display='none';let below=document.elementFromPoint(x,y);dragClone.style.display='block';let card=below?.closest('.card');if(card&&card!==dragSrcEl&&card.parentNode===dragSrcEl.parentNode){const r=card.getBoundingClientRect(),off=y-r.top-r.height/2,p=card.parentNode;if(off<0&&dragSrcEl.nextElementSibling!==card){p.insertBefore(dragSrcEl,card);vibrate(20)}else if(off>=0&&dragSrcEl.previousElementSibling!==card){p.insertBefore(dragSrcEl,card.nextSibling);vibrate(20)}}}
    const h=window.innerHeight;scrollSpeed=y<140?-(20*Math.min(1,(140-y)/60)):(y>(h-140)?20*Math.min(1,(y-(h-140))/60):0);if(scrollSpeed!==0&&!scrollInterval)autoScroll()}
function hEnd(){clearTimeout(dragTimer);if(isDrag){scrollSpeed=0;cancelAnimationFrame(scrollInterval);scrollInterval=null;document.body.classList.remove('dragging-active');dragSrcEl?.classList.remove('is-dragging-placeholder');dragClone?.remove();dragClone=null;const list=$('draftList');if(list){const ids=Array.from(list.children).map(c=>parseInt(c.dataset.id)).filter(i=>!isNaN(i));if(ids.length){state.draft=ids.map(id=>state.draft.find(x=>x.id===id)).filter(Boolean);saveData()}}}else if(dragSrcEl){const id=parseInt(dragSrcEl.dataset.id);if(id)openItemContextMenu(id,state.draft.findIndex(x=>x.id===id),state.draft.find(x=>x.id===id))}dragSrcEl=null;isDrag=!1}
function autoScroll(){if(!isDrag||scrollSpeed===0){scrollSpeed=0;cancelAnimationFrame(scrollInterval);scrollInterval=null;return}const l=$('tab-list');if(l)l.scrollTop+=scrollSpeed;scrollInterval=requestAnimationFrame(autoScroll)}

let deferredPrompt;window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;if($('installAppBtn'))$('installAppBtn').style.display='block'});
async function installPWA(){if(!deferredPrompt)return;deferredPrompt.prompt();if((await deferredPrompt.userChoice).outcome==='accepted')$('installAppBtn').style.display='none';deferredPrompt=null}

// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø PWA LOGIC ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ —Å–∫–∞—á–∞–ª–æ—Å—å –∏ –∂–¥–µ—Ç (waiting)
                if (registration.waiting) {
                    invokeUpdate(registration.waiting);
                    return;
                }

                // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫–∞—á–∞–µ—Ç—Å—è
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–∫–∞—á–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞
                            invokeUpdate(newWorker);
                        }
                    });
                });
            })
            .catch(err => console.error('SW Error:', err));
    });

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è-—Ñ–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
            refreshing = true;
            window.location.reload();
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ –æ–∫–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function invokeUpdate(worker) {
    showCustomConfirm(
        '–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
        '–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?',
        '–û–±–Ω–æ–≤–∏—Ç—å',
        '–ü–æ–∑–∂–µ',
        () => {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É Service Worker-—É —Å–º–µ–Ω–∏—Ç—å –≤–µ—Ä—Å–∏—é
            worker.postMessage({ type: 'SKIP_WAITING' });
        }
    );
}

function updateBadgesFromInputs(){$('pointsCountBadge').textContent=tempPointsDB.reduce((a,p)=>a+1+p.synonyms.length,0);$('routesCountBadge').textContent=parseList($('settingRoutes').value).length;$('notesCountBadge').textContent=parseList($('settingNotes').value).length;$('contactsCountBadge').textContent=(tempContacts.operator?.length||0)+(tempContacts.expeditor?.length||0)}
function renderManagerList(cid,list,click,rend,empty){const c=$(cid);if(!c)return;c.innerHTML='';if(!list?.length){c.innerHTML=`<div class="empty-list-stub">${empty||'–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç'}</div>`;return}list.forEach(i=>{const d=document.createElement('div');d.className='manager-card';d.onclick=()=>click(i);d.innerHTML=rend(i);c.appendChild(d)})}
function openPointsManagerScreen(){vibrate();renderPointsManager();$('view-points-manager').classList.add('active')}
function renderPointsManager(){const txt=$('pointsManagerSearch').value.toLowerCase().trim(),code=getSearchCode(txt),c=$('pointsManagerList');c.innerHTML='';
    const syns=new Set();tempPointsDB.forEach(p=>p.synonyms.forEach(s=>syns.add((typeof s==='object'?s.name:s).toLowerCase())));
    let list=[];tempPointsDB.forEach(p=>{if(!syns.has(p.name.toLowerCase()))list.push({type:'main',name:p.name,obj:p,s:getSearchCode(p.name),r:p.route,t:p.isTransit});
        p.synonyms.forEach(s=>{const isO=typeof s==='object',n=isO?s.name:s;list.push({type:'child',name:n,pid:p.id,pname:p.name,r:isO?(s.route||p.route):p.route,t:isO?(s.isTransit??p.isTransit):p.isTransit,s:getSearchCode(n),cust:isO})})});
    if(txt)list=list.filter(i=>i.s.includes(code));list.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:!0}));
    if(!list.length){c.innerHTML=`<div class="empty-state">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;return}
    list.forEach(i=>{const d=document.createElement('div');d.className='pm-card';d.onclick=()=>{vibrate(10);openPointEditor(i.type==='main'?i.obj:{isChild:!0,name:i.name,parentId:i.pid,parentName:i.pname,route:i.r,isTransit:i.t})};
        let b='';if(i.r)b+=`<span class="u-badge is-route">üó∫ ${i.r}</span>`;if(i.t)b+=`<span class="u-badge is-transit">‚áÑ –¢—Ä–∞–Ω–∑–∏—Ç</span>`;
        if(i.type==='main'&&i.obj.synonyms.length)b+=`<span class="u-badge is-syn">üîó ${i.obj.synonyms.length}</span>`;
        if(i.type==='child')b+=`<span class="u-badge" style="border:1px solid rgba(255,255,255,0.1);color:${i.cust?"var(--warning)":"#9ca3af"}">üîó ${i.pname}</span>`;
        d.innerHTML=`<div class="pm-info"><div class="pm-title">${i.name}</div><div class="pm-badges">${b||'<span style="font-size:11px;color:var(--text-muted)">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</span>'}</div></div><div class="pm-arrow">‚úé</div>`;c.appendChild(d)})}
let editingPointId=null,editingChildState=null;
function openPointEditor(data=null){vibrate();const s=$('pointEditorSheet'),n=$('editPointName'),r=$('editPointRouteBtn'),t=$('editPointTransitToggle'),del=$('btnDeletePoint'),tit=$('pointEditorTitle'),grp=s.querySelector('.settings-group'),exPi=s.querySelector('.parent-info-block');if(exPi)exPi.remove();
    editingPointId=null;editingChildState=null;tempSynonyms=[];grp.style.display='block';
    const synUI=(sh)=>{const d=sh?'block':'none';if($('synCount').parentNode) $('synCount').parentNode.style.display=d;$('synPreview').style.display=sh?'flex':'none';grp.querySelectorAll('.settings-header')[1].style.display=d;grp.querySelector('.divider').style.display=d};
    if(data&&data.isChild){editingChildState={parentId:data.parentId,oldName:data.name};tit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–î–æ—á–µ—Ä–Ω—è—è)';n.value=data.name;r.dataset.value=data.route||"";r.textContent=data.route||"–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...";r.style.color=data.route?"var(--text-main)":"var(--text-sec)";t.checked=!!data.isTransit;synUI(!1);
        const pi=document.createElement('div');pi.className='parent-info-block';pi.style.marginTop='15px';pi.innerHTML=`<div class="parent-info-title">–°–≤—è–∑—å —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º</div><div class="parent-info-text">üîó –†–æ–¥–∏—Ç–µ–ª—å: <b>${data.parentName}</b></div><div style="font-size:12px;color:#9ca3af;margin-top:5px;">–î–µ–ª–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º.</div><button class="btn-dashed" style="margin-top:10px;margin-bottom:0;border-color:var(--danger);color:var(--danger);" onclick="detachFromParent()">‚úÇÔ∏è –û—Ç–≤—è–∑–∞—Ç—å</button>`;grp.appendChild(pi);del.style.display='flex'}
    else if(data&&data.id){editingPointId=data.id;tit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';n.value=data.name;tempSynonyms=[...data.synonyms];r.dataset.value=data.route||"";r.textContent=data.route||"–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...";r.style.color=data.route?"var(--text-main)":"var(--text-sec)";t.checked=!!data.isTransit;synUI(!0);renderSynonymPreview();del.style.display='flex'}
    else{tit.textContent='–ù–æ–≤–∞—è –¢–æ—á–∫–∞';n.value='';r.dataset.value="";r.textContent="–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...";r.style.color="var(--text-sec)";t.checked=!1;synUI(!1);renderSynonymPreview();del.style.display='none'}
    requestAnimationFrame(()=>s.classList.add('active'))}
function detachFromParent(){if(!editingChildState)return;const name=$('editPointName').value.trim();if(!name)return showCustomAlert('–û—à–∏–±–∫–∞','–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');const exist=tempPointsDB.find(x=>x.name.toLowerCase()===name.toLowerCase());
    const act=()=>{const p=tempPointsDB.find(x=>x.id===editingChildState.parentId);if(p)p.synonyms=p.synonyms.filter(s=>(typeof s==='object'?s.name:s).toLowerCase()!==editingChildState.oldName.toLowerCase());
        if(!exist){tempPointsDB.push({id:Date.now()+Math.random().toString(36).substr(2,9),name,route:$('editPointRouteBtn').dataset.value||(p?p.route:""),isTransit:$('editPointTransitToggle').checked,synonyms:[]});tempPointsDB.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:!0}))}
        else{exist.route=$('editPointRouteBtn').dataset.value||"";exist.isTransit=$('editPointTransitToggle').checked}
        checkSettingsDirty();renderPointsManager();$('pointEditorSheet').classList.remove('active');showToast('‚úÖ –¢–æ—á–∫–∞ –æ—Ç–≤—è–∑–∞–Ω–∞')};
    exist?act():showCustomConfirm('–û—Ç–≤—è–∑–∫–∞',`–°–¥–µ–ª–∞—Ç—å "${name}" —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π?`,'–û—Ç–≤—è–∑–∞—Ç—å','–û—Ç–º–µ–Ω–∞',act)}
function openPointRouteSheet(){
    vibrate();
    const rBtn=$('editPointRouteBtn');
    const cur=rBtn.dataset.value||"";
    $('bsHeader').textContent='–ú–∞—Ä—à—Ä—É—Ç';
    $('bsContent').innerHTML='';
    
    state.refRoutes.forEach(r=>{
        const hint=state.routeHints[r]||'–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏';
        const d=document.createElement('div');
        d.className='bs-item route-split-item';
        if(r===cur)d.classList.add('selected');
        d.innerHTML=`<div class="rsi-left">${r}</div><div class="rsi-divider"></div><div class="rsi-right">${hint}</div>`;
        d.onclick=()=>{
            vibrate(10);
            rBtn.dataset.value=r;
            rBtn.textContent=r;
            rBtn.style.color="var(--text-main)";
            closeBottomSheet();
        };
        $('bsContent').appendChild(d);
    });
    $('bottomSheet').classList.add('active');
}
function renderSynonymPreview(){const c=$('synPreview');$('synCount').textContent=tempSynonyms.length;c.innerHTML='';tempSynonyms.forEach(s=>{const t=document.createElement('span');t.className='u-tag';t.style.cssText='font-size:10px;opacity:0.7;background:rgba(255,255,255,0.05)';t.textContent=typeof s==='object'?s.name:s;c.appendChild(t)})}
function openSynonymSelector(){vibrate();const p=$('editPointName').value.trim();if(!p)return showCustomAlert("–û—à–∏–±–∫–∞","–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏");$('bsContent').classList.add('no-scroll');$('bsHeader').textContent=`–ê–¥—Ä–µ—Å–∞ –¥–ª—è: ${p}`;$('bsContent').innerHTML=`<div class="bs-flex-wrapper"><div class="bs-static-top"><div class="wrapper-relative" style="margin-bottom:0"><input type="text" id="synSearchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." class="input-sm" style="margin-bottom:0;" autocomplete="off"></div></div><div id="synManagerList" class="chips-wrapper bs-scroll-part" style="max-height:none;justify-content:flex-start;padding-top:10px;"></div><div class="bs-static-bottom"><button class="btn-common btn-main" onclick="closeSynonymSelector()">–ì–æ—Ç–æ–≤–æ</button></div></div>`;renderSynonymChips('');$('synSearchInput').focus();$('synSearchInput').addEventListener('input',e=>renderSynonymChips(e.target.value.trim()));$('bottomSheet').classList.add('active')}
function renderSynonymChips(flt){const w=$('synManagerList');w.innerHTML='';const code=getSearchCode(flt),uniq=new Map();tempSynonyms.forEach(s=>uniq.set((typeof s==='object'?s.name:s).toLowerCase(),{text:typeof s==='object'?s.name:s,st:'mine'}));
    tempPointsDB.forEach(p=>{if(p.id===editingPointId)return;const pk=p.name.toLowerCase();if(!uniq.has(pk))uniq.set(pk,{text:p.name,st:'free',own:p.name,oid:p.id});p.synonyms.forEach(s=>{const sn=typeof s==='object'?s.name:s,sk=sn.toLowerCase();if(!uniq.has(sk))uniq.set(sk,{text:sn,st:'conflict',own:p.name,oid:p.id})})});
    let list=Array.from(uniq.values());if(flt)list=list.filter(i=>getSearchCode(i.text).includes(code));else list=[...list.filter(x=>x.st==='mine'),...list.filter(x=>x.st!=='mine').slice(0,50)];
    if(!list.length){w.innerHTML='<div class="empty-state" style="padding:20px 0;font-size:13px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return}
    list.forEach(i=>{const b=document.createElement('div');b.className=`chip ${i.st==='mine'?'active':(i.st==='conflict'?'conflict':'')}`;b.innerHTML=i.st==='conflict'?`${i.text} <small style="opacity:0.7;font-size:10px">(${i.own})</small>`:i.text;b.onclick=()=>{vibrate(10);handleSynonymClick(i)};w.appendChild(b)})}
function handleSynonymClick(i){if(i.st==='mine'){tempSynonyms=tempSynonyms.filter(s=>(typeof s==='object'?s.name:s).toLowerCase()===i.text.toLowerCase());renderSynonymChips($('synSearchInput').value.trim())}else if(i.st==='free'){const ex=tempPointsDB.find(x=>x.name.toLowerCase()===i.text.toLowerCase());const act=()=>{tempSynonyms.push({name:i.text,route:ex?ex.route:"",isTransit:ex?!!ex.isTransit:!1});renderSynonymChips($('synSearchInput').value.trim())};(ex&&ex.synonyms.length)?showCustomConfirm("–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ","–¢–æ—á–∫–∞ –∏–º–µ–µ—Ç —Å–≤–æ–∏ –∞–¥—Ä–µ—Å–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?","–î–∞","–ù–µ—Ç",act):act()}else if(i.st==='conflict'){showCustomConfirm("–ö–æ–Ω—Ñ–ª–∏–∫—Ç",`–£–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ "${i.own}". –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏?`,"–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏","–û—Ç–º–µ–Ω–∞",()=>{const o=tempPointsDB.find(x=>x.id===i.oid);let stol={};if(o){const old=o.synonyms.find(s=>(typeof s==='object'?s.name:s).toLowerCase()===i.text.toLowerCase());if(typeof old==='object')stol={r:old.route,t:old.isTransit};o.synonyms=o.synonyms.filter(s=>(typeof s==='object'?s.name:s).toLowerCase()!==i.text.toLowerCase())}tempSynonyms.push({name:i.text,route:stol.r||"",isTransit:stol.t||!1});renderSynonymChips($('synSearchInput').value.trim())})}}
function closeSynonymSelector(){$('bottomSheet').classList.remove('active');$('bsContent').classList.remove('no-scroll');renderSynonymPreview()}
function savePointUnified(){const n=$('editPointName').value.trim();if(!n)return showCustomAlert('–û—à–∏–±–∫–∞','–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');const r=$('editPointRouteBtn').dataset.value||"",t=$('editPointTransitToggle').checked;
    if(!r) return showCustomAlert('–û—à–∏–±–∫–∞','–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!'); 
    if(editingChildState){const p=tempPointsDB.find(x=>x.id===editingChildState.parentId);if(p){const i=p.synonyms.findIndex(s=>(typeof s==='object'?s.name:s)===editingChildState.oldName);if(i!==-1)p.synonyms[i]={name:n,route:r,isTransit:t}}showToast(`‚úÖ –ê–¥—Ä–µ—Å –æ–±–Ω–æ–≤–ª–µ–Ω`)}
    else{const fs=tempSynonyms.map(s=>(typeof s==='string'?{name:s,route:"",isTransit:!1}:s));fs.forEach(c=>{const idx=tempPointsDB.findIndex(x=>x.name.toLowerCase()===c.name.toLowerCase()&&x.id!==editingPointId);if(idx!==-1)tempPointsDB.splice(idx,1)});
    if(editingPointId){const i=tempPointsDB.find(x=>x.id===editingPointId);if(i){i.name=n;i.route=r;i.isTransit=t;i.synonyms=fs}showToast(`‚úÖ –†–æ–¥–∏—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω`)}else{if(tempPointsDB.some(x=>x.name.toLowerCase()===n.toLowerCase()))return showCustomAlert('–û—à–∏–±–∫–∞','–ò–º—è –∑–∞–Ω—è—Ç–æ');tempPointsDB.push({id:Date.now()+Math.random().toString(36).substr(2,9),name:n,route:r,isTransit:t,synonyms:fs});showToast(`‚úÖ –†–æ–¥–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω`)}}
    tempPointsDB.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:!0}));renderPointsManager();checkSettingsDirty();$('pointEditorSheet').classList.remove('active')}
function deletePointFromEditor(){if(editingChildState){showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{const p=tempPointsDB.find(x=>x.id===editingChildState.parentId);if(p)p.synonyms=p.synonyms.filter(s=>(typeof s==='object'?s.name:s).toLowerCase()!==editingChildState.oldName.toLowerCase());renderPointsManager();checkSettingsDirty();$('pointEditorSheet').classList.remove('active')});return}if(!editingPointId)return;const p=tempPointsDB.find(x=>x.id===editingPointId);showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å "${p.name}"?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{if(p&&p.synonyms.length)p.synonyms.forEach(c=>{const cn=typeof c==='object'?c.name:c;tempPointsDB.push({id:Date.now()+Math.random().toString(36).substr(2,9),name:cn,route:(typeof c==='object'?c.route:p.route)||"",isTransit:!!(typeof c==='object'?c.isTransit:p.isTransit),synonyms:[]})});tempPointsDB=tempPointsDB.filter(x=>x.id!==editingPointId);renderPointsManager();checkSettingsDirty();$('pointEditorSheet').classList.remove('active')})}
function openRoutesManagerScreen(){vibrate();renderRoutesManager();$('view-routes-manager').classList.add('active')}
function renderRoutesManager(){renderManagerList('routesManagerList',parseList($('settingRoutes').value),openRouteEditor,r=>`<div class="rm-info"><div class="rm-title">${r}<span class="rm-badge">–ú–ê–†–®–†–£–¢</span></div><div class="rm-hint">${tempHints[r]||state.routeHints[r]||'(–ù–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏)'}</div></div><div class="rm-icon">‚úé</div>`,'–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤')}
let editingRouteOldName=null;
function openRouteEditor(n=null){vibrate();editingRouteOldName=n;$('editRouteName').value=n||'';$('editRouteHint').value=n?(tempHints[n]||state.routeHints[n]||''):'';$('btnDeleteRoute').style.display=n?'flex':'none';$('routeEditorTitle').textContent=n?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç':'–ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç';$('routeEditorSheet').classList.add('active')}
function saveRouteFromEditor(){const n=$('editRouteName').value.trim(),h=$('editRouteHint').value.trim();if(!n)return showCustomAlert('–û—à–∏–±–∫–∞','–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');let l=parseList($('settingRoutes').value);if(editingRouteOldName&&editingRouteOldName!==n){l=l.filter(r=>r!==editingRouteOldName);delete tempHints[editingRouteOldName]}if(!editingRouteOldName&&l.includes(n))return showCustomAlert('–û—à–∏–±–∫–∞','–î—É–±–ª–∏–∫–∞—Ç');if(!l.includes(n)){l.push(n);l.sort((a,b)=>a.localeCompare(b,undefined,{numeric:!0}))}tempHints[n]=h;$('settingRoutes').value=l.join(', ');renderRoutesManager();checkSettingsDirty();$('routeEditorSheet').classList.remove('active')}
function deleteRouteFromEditor(){if(!editingRouteOldName)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å "${editingRouteOldName}"?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{let l=parseList($('settingRoutes').value).filter(r=>r!==editingRouteOldName);delete tempHints[editingRouteOldName];$('settingRoutes').value=l.join(', ');renderRoutesManager();checkSettingsDirty();$('routeEditorSheet').classList.remove('active')})}
function openNotesManagerScreen(){vibrate();renderManagerList('notesManagerList',parseList($('settingNotes').value),openNoteEditor,n=>`<div class="rm-info"><div class="azs-title">${n}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`);$('view-notes-manager').classList.add('active')}
let editingNoteOldName=null;
function openNoteEditor(n=null){vibrate();editingNoteOldName=n;$('editNoteName').value=n||'';$('btnDeleteNote').style.display=n?'flex':'none';$('noteEditorTitle').textContent=n?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É':'–ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞';$('noteEditorSheet').classList.add('active')}
function saveNoteFromEditor(){const n=$('editNoteName').value.trim();if(!n)return showCustomAlert('–û—à–∏–±–∫–∞','–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');let l=parseList($('settingNotes').value);if(editingNoteOldName&&editingNoteOldName!==n){const i=l.indexOf(editingNoteOldName);if(i!==-1)l.splice(i,1)}if(l.map(x=>x.toLowerCase()).includes(n.toLowerCase()))return showCustomAlert('–û—à–∏–±–∫–∞','–î—É–±–ª–∏–∫–∞—Ç');l.push(n);l.sort((a,b)=>a.localeCompare(b,undefined,{numeric:!0}));$('settingNotes').value=l.join(', ');renderManagerList('notesManagerList',parseList($('settingNotes').value),openNoteEditor,x=>`<div class="rm-info"><div class="azs-title">${x}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`);checkSettingsDirty();$('noteEditorSheet').classList.remove('active')}
function deleteNoteFromEditor(){if(!editingNoteOldName)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ',`–£–¥–∞–ª–∏—Ç—å?`,'–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{let l=parseList($('settingNotes').value),i=l.indexOf(editingNoteOldName);if(i!==-1){l.splice(i,1);$('settingNotes').value=l.join(', ');renderManagerList('notesManagerList',l,openNoteEditor,x=>`<div class="rm-info"><div class="azs-title">${x}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`);checkSettingsDirty()}$('noteEditorSheet').classList.remove('active')})}
let editingContactType='operator',editingContactId=null;
function openContactsManagerScreen(){vibrate();if(!tempContacts.operator)tempContacts=JSON.parse(JSON.stringify(state.contacts||{operator:[],expeditor:[]}));const r=(t,c)=>renderManagerList(c,tempContacts[t]||[],x=>openContactEditor(x,t),x=>`<div class="rm-info"><div class="azs-title" style="font-weight:700;">${x.name}</div><div style="font-size:12px;color:var(--text-sec);font-family:monospace;margin-top:2px;">${x.phone}</div></div><div class="rm-icon" style="font-size:16px;">‚úé</div>`);r('operator','contactsOperatorList');r('expeditor','contactsExpeditorList');$('view-contacts-manager').classList.add('active')}
function openContactEditor(c=null,t='operator'){vibrate();editingContactType=t;const lbl=t==='operator'?'–û–ø–µ—Ä–∞—Ç–æ—Ä':'–≠–∫—Å–ø–µ–¥–∏—Ç–æ—Ä';editingContactId=c?c.id:null;$('contactNameInput').value=c?c.name:'';$('contactPhoneInput').value=c?c.phone:'';$('btnDeleteContact').style.display=c?'flex':'none';$('contactEditorTitle').textContent=c?`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (${lbl})`:`–ù–æ–≤—ã–π ${lbl}`;$('contactEditorSheet').classList.add('active')}
function saveContactFromEditor(){const n=$('contactNameInput').value.trim(),p=$('contactPhoneInput').value.trim();if(!n||!p)return showCustomAlert('–û—à–∏–±–∫–∞','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');if(!tempContacts[editingContactType])tempContacts[editingContactType]=[];if(editingContactId){const i=tempContacts[editingContactType].findIndex(x=>x.id===editingContactId);if(i!==-1)tempContacts[editingContactType][i]={id:editingContactId,name:n,phone:p}}else{tempContacts[editingContactType].push({id:Date.now(),name:n,phone:p})}openContactsManagerScreen();checkSettingsDirty();$('contactEditorSheet').classList.remove('active')}
function deleteContactFromEditor(){if(!editingContactId)return;showCustomConfirm('–£–¥–∞–ª–µ–Ω–∏–µ','–£–¥–∞–ª–∏—Ç—å?','–£–¥–∞–ª–∏—Ç—å','–û—Ç–º–µ–Ω–∞',()=>{if(tempContacts[editingContactType])tempContacts[editingContactType]=tempContacts[editingContactType].filter(x=>x.id!==editingContactId);openContactsManagerScreen();checkSettingsDirty();$('contactEditorSheet').classList.remove('active')})}
function openDataManagerScreen(){vibrate();const el=$('view-data-manager');if(el)el.classList.add('active')} 
const closeEditorSheet=(e,id)=>{if(!e||e.target.classList.contains('bs-overlay')){$(id).classList.remove('active');if(document.activeElement)document.activeElement.blur()}};
function exportData() {
    vibrate();
    const data = {
        draft: state.draft,
        archive: state.archive,
        settings: {
            pointsDB: state.pointsDB,
            refRoutes: state.refRoutes,
            refNotes: state.refNotes,
            routeHints: state.routeHints,
            contacts: state.contacts
        }
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TP_Backup_${new Date().toLocaleDateString()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
init();
</script>
</body>
</html>